<!DOCTYPE html>
<html lang="en" dir="ltr" class="no-js">
<head>
    <meta charset="utf-8" />
    <title>tutorial:synthesis:buck:start - Workcraft</title>
    <script>(function(H){H.className=H.className.replace(/\bno-js\b/,'js')})(document.documentElement)</script>
    <meta name="generator" content="DokuWiki"/>
<meta name="robots" content="noindex,nofollow"/>
<meta name="keywords" content="tutorial,synthesis,buck,start"/>
<link rel="search" type="application/opensearchdescription+xml" href="../../lib/exe/opensearch.html" title="Workcraft"/>
<link rel="start" href="start.html"/>
<link rel="contents" href="start.html" title="Sitemap"/>
<link rel="alternate" type="application/rss+xml" title="Changes" />
<link rel="alternate" type="application/rss+xml" title="Current namespace" />
<link rel="edit" title="Edit this page" href="start.html"/>
<link rel="alternate" type="text/html" title="Plain HTML" href="../../_export/xhtml/tutorial/synthesis/buck/start.xhtml"/>
<link rel="alternate" type="text/plain" title="Wiki Markup" href="../../_export/raw/tutorial/synthesis/buck/start.raw"/>
<link rel="canonical" href="https://workcraft.org/tutorial/synthesis/buck/start"/>
<link rel="stylesheet" type="text/css" href="../../lib/exe/css.php.t.dokuwiki-light-export.css"/>
<!--[if gte IE 9]><!-->
<script type="text/javascript">/*<![CDATA[*/var NS='tutorial:synthesis:buck';var SIG=' --- //[[danilovesky@gmail.com|Danil Sokolov]] 2018/10/31 22:46//';var JSINFO = {"id":"tutorial:synthesis:buck:start","namespace":"tutorial:synthesis:buck","fastwiki":{"secedit":1,"preview":1,"fastpages":1,"save":0,"fastshow":0,"fastshow_same_ns":1,"fastshow_include":"","fastshow_exclude":"","preload":false,"preload_head":"====47hsjwycv782nwncv8b920m8bv72jmdm3929bno3b3====","preload_batchsize":false,"preload_per_page":false,"locktime":840,"usedraft":1,"text_btn_show":"Show page","templatename":"dokuwiki-light-export"},"act":"show","ajax":"ajax","move_renameokay":true,"plugin_slider":{"width":800,"mode":"horizontal","infiniteLoop":true,"hideControlOnEnd":false,"speed":500,"easing":null,"slideMargin":0,"startSlide":0,"randomStart":false,"captions":false,"ticker":false,"tickerHover":false,"adaptiveHeight":false,"adaptiveHeightSpeed":500,"video":false,"useCSS":true,"preloadImages":"visible","responsive":true,"pager":true,"pagerType":"full","pagerShortSeparator":"\/","controls":true,"nextText":"Next","prevText":"Prev","autoControls":false,"startText":"Start","stopText":"Stop","autoControlsCombine":false,"auto":false,"pause":4000,"autoStart":true,"autoDirection":"next","autoHover":false,"autoDelay":0,"minSlides":1,"maxSlides":1,"moveSlides":0,"slideWidth":0,"touchEnabled":true,"swipeThreshold":50,"oneToOneTouch":true,"preventDefaultSwipeX":true,"preventDefaultSwipeY":false},"plugin_folded":{"hide":"hide","reveal":"reveal"}};
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="../../lib/exe/jquery.php.t.dokuwiki-light-export.js"></script>
<script type="text/javascript" charset="utf-8" src="../../lib/exe/js.php.t.dokuwiki-light-export.js"></script>
<!--<![endif]-->
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="shortcut icon" href="../../favicon.ico" />
<link rel="apple-touch-icon" href="../../apple-touch-icon.png" />
    </head>

<body>
    <div id="dokuwiki__site"><div id="dokuwiki__top" class="site dokuwiki mode_show tpl_dokuwiki-light-export loggedIn    ">

        
<!-- ********** HEADER ********** -->
<div id="dokuwiki__header"><div class="pad group">

        <h1><a href="../../start.html"  title="Workcraft start page"><img src="../../logo.png" width="327" height="57" alt="" /></a></h1>
    
    <div class="tools group">
        <!-- USER TOOLS -->
<!--
                    <div id="dokuwiki__usertools">
                <h3 class="a11y">User Tools</h3>
                <ul>
                    <li><a href="start.html"  class="action admin" rel="nofollow" title="Admin">Admin</a></li><li><a href="start.html"  class="action profile" rel="nofollow" title="Profile">Profile</a></li><li><a href="start.html"  class="action logout" rel="nofollow" title="Log Out">Log Out</a></li>                </ul>
            </div>
        -->

        <!-- SEARCH TOOLS -->
<!--
        <div id="dokuwiki__searchtools">
            <h3 class="a11y"></h3>
            <form action="../../start.html" accept-charset="utf-8" class="search" id="dw__search" method="get" role="search"><div class="no"><input type="hidden" name="do" value="search" /><input type="text" placeholder="Search" id="qsearch__in" accesskey="f" name="id" class="edit" title="[F]" /><button type="submit" title="Search">Search</button><div id="qsearch__out" class="ajax_qsearch JSpopup"></div></div></form>        </div>
-->

        <!-- SITE TOOLS -->
<!--
        <div id="dokuwiki__sitetools">
            <h3 class="a11y">Site Tools</h3>
                            <div class="mobileTools">
                    <form action="../..//doku.html.doku.php.html" method="get" accept-charset="utf-8"><div class="no"><input type="hidden" name="id" value="tutorial:synthesis:buck:start" /><input type="hidden" name="sectok" value="e8ce0b2f48c09a60940b0543b6d11f28" /><select name="do" class="edit quickselect" title="Tools"><option value="">Tools</option><optgroup label="Page Tools"><option value="edit">Edit this page</option><option value="revisions">Old revisions</option><option value="backlink">Backlinks</option></optgroup><optgroup label="Site Tools"><option value="recent">Changes</option><option value="media">Manager</option><option value="index">Sitemap</option></optgroup><optgroup label="User Tools"><option value="logout">Log Out</option><option value="profile">Profile</option><option value="admin">Admin</option></optgroup></select><button type="submit">&gt;</button></div></form>                </div>
                <ul>
                    <li><a href="start.html"  class="action recent" accesskey="r" rel="nofollow" title="Changes [R]">Changes</a></li><li><a href="start.html"  class="action media" rel="nofollow" title="Manager">Manager</a></li><li><a href="start.html"  class="action index" accesskey="x" rel="nofollow" title="Sitemap [X]">Sitemap</a></li>                </ul>
                    </div>
-->
    </div>

    <!-- BREADCRUMBS -->
<!--
    -->



    <hr class="a11y" />
</div></div><!-- /header -->

        <div class="wrapper group">

            
            <!-- ********** CONTENT ********** -->
            <div id="dokuwiki__content"><div class="pad group">
                
                <div class="pageId"><span>tutorial:synthesis:buck:start</span></div>

                <div class="page group">
                                                            <!-- wikipage start -->
                    <div class="plugin_fastwiki_marker" style="display:none"></div><!-- TOC START -->
<div id="dw__toc">
<h3 class="toggle">Table of Contents</h3>
<div>

<ul class="toc">
<li class="level1"><div class="li"><a href="#exercise_1modelling">Exercise 1: Modelling</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="#simplification">Simplification</a></div></li>
</ul>
</li>
<li class="level1"><div class="li"><a href="#exercise_2validation_and_formal_verification_of_specification">Exercise 2: Validation and formal verification of specification</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="#validation">Validation</a></div></li>
<li class="level2"><div class="li"><a href="#formal_verification">Formal verification</a></div></li>
</ul>
</li>
<li class="level1"><div class="li"><a href="#exercise_3synthesis">Exercise 3: Synthesis</a></div></li>
<li class="level1"><div class="li"><a href="#exercise_4validation_and_formal_verification_of_implementation">Exercise 4: Validation and formal verification of implementation</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="#validation1">Validation</a></div></li>
<li class="level2"><div class="li"><a href="#formal_verification1">Formal verification</a></div></li>
</ul>
</li>
<li class="level1"><div class="li"><a href="#exercise_5alternative_implementations_optional">Exercise 5: Alternative implementations (optional)</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="#standard-c_implementation">Standard-C implementation</a></div></li>
<li class="level2"><div class="li"><a href="#logic_decomposition_and_technology_mapping">Logic decomposition and technology mapping</a></div></li>
</ul>
</li>
<li class="level1"><div class="li"><a href="#solutions">Solutions</a></div></li>
</ul>
</div>
</div>
<!-- TOC END -->

<h1 id="design_of_basic_buck_controller">Design of basic buck controller</h1>
<div class="level1">

<p>
<a href="https://en.wikipedia.org/wiki/Buck converter" class="interwiki iw_wp" title="https://en.wikipedia.org/wiki/Buck converter">Buck converter</a> is a voltage step down and current step up converter. It comprises an analogue buck and its digital control logic as shown in the following diagram. Your task in this tutorial is to formally specify, synthesise and verify the control circuitry of the buck.
</p>

<p>
<img src="buck-schematic_diagram.svg" width="417" height="311" class="svgscaleinsert mediacenter" alt="tutorial:synthesis:buck:buck-schematic_diagram.svg">
</p>

<p>
The controller switches the power regulating PMOS and NMOS transistors ON and OFF as a reaction to under-voltage (UV), over-current (OC) and zero-crossing (ZC) conditions. These conditions are detected and signalled by a set of specialised sensors implemented as comparators of measured current and voltage levels against some reference values (<code>V_ref</code>, <code>I_max</code> and <code>I_0</code> respectively). Note that the <code><span style='color:blue; '>gp</span></code> and <code><span style='color:blue; '>gn</span></code> signals are buffered to drive the very large power regulating transistors (occupy more than 50% of the buck area) and their effect on the buck can be significantly delayed. Therefore, the controller is explicitly notified (by the <code><span style='color:red; '>gp_ack</span></code> and <code><span style='color:red; '>gn_ack</span></code> signals) when the power transistor threshold levels (<code>Th_pmos</code> and <code>Th_nmos</code>) are crossed.
</p>

<p>
The operation of a buck is usually specified in an intuitive, but rather informal way, e.g. by enumerating the possible sequences of detected conditions and describing the intended reaction to them, as in the following phase diagram.
</p>

<p>
<img src="buck-phase_diagram.svg" width="600" height="151" class="svgscaleinsert mediacenter" alt="tutorial:synthesis:buck:buck-phase_diagram.svg">
</p>

<p>
This specification shows the alternation of the UV and OC conditions which are handled by switching the power regulating PMOS and NMOS transistors of the buck ON and OFF. Detection of the ZC condition after UV does not change this behaviour, however, if ZC is detected before UV then both the PMOS and NMOS transistors remain OFF until the UV event. 
</p>

<p>
It is important to note that in order to avoid a short-circuit the PMOS and NMOS transistors of the buck must never be ON at the same time.
</p>

</div>

<h2 id="exercise_1modelling">Exercise 1: Modelling</h2>
<div class="level2">

<p>
According to the phase diagram there are three distinctive scenarios to capture:
</p>
<ul>
<li class="level"><div class="li">
 <strong>no ZC</strong> – UV happens without ZC;
</div></li>
<li class="level"><div class="li">
 <strong>late ZC</strong> – UV is followed by ZC;
</div></li>
<li class="level"><div class="li">
 <strong>early ZC</strong> – UV happens after ZC. 
</div></li>
</ul>


<p>
Let us first capture the <strong>no ZC</strong> scenario as an <abbr title="Signal Transition Graph">STG</abbr>.
</p>
<p><a class="folder" href="#folded_tutorial:synthesis:buck:start_1">Detailed instructions </a></p><div class="folded hidden" id="folded_tutorial:synthesis:buck:start_1"><ul>
<li class="level"><div class="li">
 Initially the NMOS transistor is ON and the PMOS transistor is OFF which should lead to the UV condition:
</div><ul>
<li class="level"><div class="li">
 Create a place <code>p0</code> and mark it with a token - this denotes the initial state. 
</div></li>
<li class="level"><div class="li">
 Create a rising phase of an input signal and call it <code><span style='color:red; '>uv+</span></code>.
</div></li>
<li class="level"><div class="li">
 Connect the place <code>p0</code> to the transition <code><span style='color:red; '>uv+</span></code>.
</div></li>
</ul>
</li>
<li class="level"><div class="li">
 When UV is detected the NMOS transistor needs to be switched OFF:
</div><ul>
<li class="level"><div class="li">
 Create an output transition <code><span style='color:blue; '>gn-</span></code>. 
</div></li>
<li class="level"><div class="li">
 Connect <code><span style='color:red; '>uv+</span></code> to <code><span style='color:blue; '>gn-</span></code>.
</div></li>
</ul>
</li>
<li class="level"><div class="li">
 Wait for indication of NMOS transistor being OFF:
</div><ul>
<li class="level"><div class="li">
 Create an input transition <code><span style='color:red; '>gn_ack-</span></code>.
</div></li>
<li class="level"><div class="li">
 Connect <code><span style='color:blue; '>gn-</span></code> to <code><span style='color:red; '>gn_ack-</span></code>,
</div></li>
</ul>
</li>
<li class="level"><div class="li">
 When the OFF state of NMOS is confirmed the PMOS transistor can be switched ON to charge the buck:
</div><ul>
<li class="level"><div class="li">
 Create an output transition <code><span style='color:blue; '>gp+</span></code> and an input transition <code><span style='color:red; '>gp_ack+</span></code>. 
</div></li>
<li class="level"><div class="li">
 Connect <code><span style='color:red; '>gn_ack-</span></code> to <code><span style='color:blue; '>gp+</span></code> and <code><span style='color:blue; '>gp+</span></code> to <code><span style='color:red; '>gp_ack+</span></code>.
</div></li>
</ul>
</li>
<li class="level"><div class="li">
 Eventually the buck will saturate leading to reset of UV and OC conditions:
</div><ul>
<li class="level"><div class="li">
 Create input transitions <code><span style='color:red; '>uv-</span></code> and <code><span style='color:red; '>oc+</span></code>.
</div></li>
<li class="level"><div class="li">
 Connect <code><span style='color:red; '>gp_ack+</span></code> to <code><span style='color:red; '>uv-</span></code> and <code><span style='color:red; '>uv-</span></code> to <code><span style='color:red; '>oc+</span></code>.
</div></li>
</ul>
</li>
<li class="level"><div class="li">
 At this stage the PMOS transistor needs to be switched OFF:
</div><ul>
<li class="level"><div class="li">
 Create an output transition <code><span style='color:blue; '>gp-</span></code> and an input transition <code><span style='color:red; '>gp_ack-</span></code>.
</div></li>
<li class="level"><div class="li">
 Connect <code><span style='color:red; '>oc+</span></code> to <code><span style='color:blue; '>gp-</span></code> and <code><span style='color:blue; '>gp-</span></code> to <code><span style='color:red; '>gp_ack-</span></code>.
</div></li>
</ul>
</li>
<li class="level"><div class="li">
 After the OFF state of the PMOS transistor is confirmed the NMOS transistor is switched ON state:
</div><ul>
<li class="level"><div class="li">
 Create an output transition <code><span style='color:blue; '>gn+</span></code> and an input transition <code><span style='color:red; '>gn_ack+</span></code>.
</div></li>
<li class="level"><div class="li">
 Connect <code><span style='color:red; '>gp_ack-</span></code> to <code><span style='color:blue; '>gn+</span></code> and <code><span style='color:blue; '>gn+</span></code> to <code><span style='color:red; '>gn_ack+</span></code>.
</div></li>
</ul>
</li>
<li class="level"><div class="li">
 This leads to the release of OC and brings the controller to the initial state:
</div><ul>
<li class="level"><div class="li">
 Create an input transition <code><span style='color:red; '>oc-</span></code>.
</div></li>
<li class="level"><div class="li">
 Connect <code><span style='color:red; '>gn_ack+</span></code> to <code><span style='color:red; '>oc-</span></code>.
</div></li>
<li class="level"><div class="li">
 Connect <code><span style='color:red; '>oc-</span></code> to the place <code>p0</code>.
</div></li>
</ul>
</li>
</ul>

</div>
<p>
The resulting <abbr title="Signal Transition Graph">STG</abbr> listing the sequence of signal events for this scenario is shown in the following diagram. Save this model as <em>buck-scenario1_no_zc.stg.work</em> file.
</p>

<p>
<img src="buck-scenario1_no_zc.stg.svg" width="377" height="93" class="svgscaleinsert mediacenter" alt="tutorial:synthesis:buck:buck-scenario1_no_zc.stg.svg">
</p>

<p>
The scenario for <em>late ZC</em> is formalised in a very similar way. Both phases of ZC just happen concurrently with switching NMOS transistor OFF and PMOS transistor ON. Save the <em>no ZC</em> model with new name <em>buck-scenario2_late_zc.stg.work</em> and modify it according to the <em>late ZC</em> scenario.
</p>
<p><a class="folder" href="#folded_tutorial:synthesis:buck:start_2">Detailed instructions </a></p><div class="folded hidden" id="folded_tutorial:synthesis:buck:start_2"><ul>
<li class="level"><div class="li">
 Create two input signal transitions <code><span style='color:red; '>zc+</span></code> and <code><span style='color:red; '>zc-</span></code>.
</div></li>
<li class="level"><div class="li">
 Connect <code><span style='color:red; '>uv+</span></code> to <code><span style='color:red; '>zc+</span></code>.
</div></li>
<li class="level"><div class="li">
 Connect <code><span style='color:red; '>zc+</span></code> to <code><span style='color:red; '>zc-</span></code>.
</div></li>
<li class="level"><div class="li">
 Connect <code><span style='color:red; '>zc-</span></code> to <code><span style='color:red; '>uv-</span></code>.
</div></li>
</ul>

</div>
<p>
The resulting <abbr title="Signal Transition Graph">STG</abbr> should look similar to the following diagram. Do not forget to save the work!
</p>

<p>
<img src="buck-scenario2_late_zc.stg.svg" width="377" height="93" class="svgscaleinsert mediacenter" alt="tutorial:synthesis:buck:buck-scenario2_late_zc.stg.svg">
</p>

<p>
The scenario for early arrival of ZC is a bit different. Here the NMOS transistor needs to be switched OFF  as soon as ZC is detected, without waiting for UV. However, switching the PMOS transistor ON is still delayed till UV condition.
</p>

<p>
Save the <em>late ZC</em> model under new name <em>buck-scenario3_early_zc.stg.work</em> and do the necessary changes for the <em>early ZC</em> scenario.
</p>
<p><a class="folder" href="#folded_tutorial:synthesis:buck:start_3">Detailed instructions </a></p><div class="folded hidden" id="folded_tutorial:synthesis:buck:start_3"><ul>
<li class="level"><div class="li">
 Delete incoming and outgoing arcs of <code><span style='color:red; '>uv+</span></code> and <code><span style='color:red; '>zc+</span></code> transitions (just select the arc and press <kbd class="__keyboard">Delete</kbd>).
</div></li>
<li class="level"><div class="li">
 Connect place <code>p0</code> to <code><span style='color:red; '>zc+</span></code> and <code><span style='color:red; '>zc+</span></code> to <code><span style='color:blue; '>gn-</span></code>.
</div></li>
<li class="level"><div class="li">
 Connect <code><span style='color:red; '>zc+</span></code> to <code><span style='color:red; '>uv+</span></code> and <code><span style='color:red; '>uv+</span></code> to <code><span style='color:blue; '>gp+</span></code>.
</div></li>
<li class="level"><div class="li">
 Connect <code><span style='color:blue; '>gp+</span></code> to <code><span style='color:red; '>zc-</span></code>.
</div></li>
<li class="level"><div class="li">
 Rearrange transitions to make the <abbr title="Signal Transition Graph">STG</abbr> look nicer (using the selection tool) and save the work.
</div></li>
</ul>

</div>
<p>
The modified <abbr title="Signal Transition Graph">STG</abbr> should look similar to the following diagram.
</p>

<p>
<img src="buck-scenario3_early_zc.stg.svg" width="377" height="93" class="svgscaleinsert mediacenter" alt="tutorial:synthesis:buck:buck-scenario3_early_zc.stg.svg">
</p>

<p>
In order to produce an implementation capable of handling all the scenarios, these STGs need to be merged into a single specification. One can see that all three STGs have ‘compatible’ initial states, that is all common input and output signals have the same initial values. Therefore one can merge the initially marked places in the three STGs and obtain a combined specification for buck control.
</p>
<ul>
<li class="level"><div class="li">
 Create a new <abbr title="Signal Transition Graph">STG</abbr> work called <em>buck-scenarios_merged.stg.work</em>.
</div></li>
<li class="level"><div class="li">
 Copy and paste the three scenarios into it.
</div></li>
<li class="level"><div class="li">
 Select the three initially marked places (by holding <kbd class="__keyboard">Shift</kbd> and clicking them with the mouse) and merge them into a single place using <em>Transformations→Merge selected places</em>.
</div></li>
</ul>


<p>
The <abbr title="Signal Transition Graph">STG</abbr> combining all three scenarios should look like the following diagram. Do not forget to save the work!
</p>

<p>
<img src="buck-scenarios_merged.stg.svg" width="427" height="338" class="svgscaleinsert mediacenter" alt="tutorial:synthesis:buck:buck-scenarios_merged.stg.svg">
</p>
<div class="wrap_center wrap_round wrap_tip plugin_wrap" style="width: 90%;">
<p>
Note that this <abbr title="Signal Transition Graph">STG</abbr> is <em>non-deterministic</em>, e.g. after <code><span style='color:red; '>uv+</span></code> fires the <abbr title="Signal Transition Graph">STG</abbr> can end up in either of the two possible states. Non-determinism is common in scenario-based modelling, and can be very powerful and expressive. Occasionally, the scenarios may impose conflicting requirements on the system (e.g. two scenarios may have a common prefix, with one of them requiring and the other forbidding the circuit to produce a particular output after this prefix). Such conflicting requirements can be detected during verification. In this model, however, the scenarios are compatible.
</p>
</div>
</div>

<h3 id="simplification">Simplification</h3>
<div class="level3">

<p>
Once the initially marked places are merged, one can notice that three transitions <code><span style='color:red; '>oc-</span></code> leading to it can also be merged because their preceding states are ‘compatible’. This process continues with signal event <code><span style='color:red; '>gn_ack+</span></code>, and so on, ‘zipping’ the common paths of the STGs together. The simplified <abbr title="Signal Transition Graph">STG</abbr> specification of the buck control is as follows; save it as <em>buck-simplified.stg.work</em> file.
</p>

<p>
<img src="buck-simplified.stg.svg" width="476" height="233" class="svgscaleinsert mediacenter" alt="tutorial:synthesis:buck:buck-simplified.stg.svg">
</p>

<p>
Note that this <abbr title="Signal Transition Graph">STG</abbr> is just a cosmetic improvement over the previous one and so this step does not affect the verification and synthesis. However, it does improve the visual representation making the <abbr title="Signal Transition Graph">STG</abbr> more comprehensible, and thus it is important from the designer&#039;s perspective.
</p>
<div class="wrap_center wrap_round wrap_tip plugin_wrap" style="width: 90%;">
<p>
It is possible to simplify the <abbr title="Signal Transition Graph">STG</abbr> automatically, via the <em>Conversion→Net synthesis [Petrify]</em> or <em>Conversion→Net synthesis [Petrify with -er option]</em> menu items. However, the layout of the simplified <abbr title="Signal Transition Graph">STG</abbr> is generated automatically, so the manual simplification is simpler for this example. However, in less trivial cases automatic simplification can be very useful.
</p>
</div>
</div>

<h2 id="exercise_2validation_and_formal_verification_of_specification">Exercise 2: Validation and formal verification of specification</h2>
<div class="level2">

</div>

<h3 id="validation">Validation</h3>
<div class="level3">

<p>
Activate the <strong>simulation tool</strong> <img src="../../../help/core/editor_tools-simulate.png" class="media" title="[M] Simulate" alt="[M] Simulate" /> and exercise the obtained <abbr title="Signal Transition Graph">STG</abbr> model. Click one of the enabled signal transitions (they are highlighted in orange) to <em>evaluate</em> the <abbr title="Signal Transition Graph">STG</abbr> into the next state. Make sure the simulation traces correspond to those intended by the informal specification of the phase diagram.
</p>

</div>

<h3 id="formal_verification">Formal verification</h3>
<div class="level3">

<p>
Before proceeding to the synthesis step verify that the <abbr title="Signal Transition Graph">STG</abbr> specification satisfies the following <a href="../../../help/verification.html" class="wikilink1" title="help:verification">Verification properties</a> using <em>Verification</em> menu: 
</p>
<ul>
<li class="level"><div class="li">
 Deadlock freeness – every reachable marking enables at least one transition. 
</div></li>
<li class="level"><div class="li">
 Consistency – the &#039;+&#039; and &#039;-&#039; transitions of every signal alternate in every execution, always starting with the same sign. 
</div></li>
<li class="level"><div class="li">
 Input properness – an input cannot be disabled by an output or internal signal, and cannot be triggered by an internal signal. 
</div></li>
<li class="level"><div class="li">
 Output persistency – an enabled output or internal signal cannot be disabled by any other signal. 
</div></li>
</ul>


<p>
These are basic soundness properties which should be satisfied by most models – Verification menu has an entry that can check all these properties with a single click. 
</p>

<p>
Another property one must verify is that PMOS and NMOS transistors are never ON simultaneously (which would lead to a short-circuit), i.e. that signals <code><span style='color:blue; '>gp</span></code> and <code><span style='color:blue; '>gn</span></code> are never high at the same time. This custom property can be formulated as a reachability analysis problem using <a href="../../../help/reach.html" class="wikilink1" title="help:reach">Reach language</a>:
</p>
<ul>
<li class="level"><div class="li">
 Open the <em>Custom property definition</em> window by selecting <em>Verification→Custom properties [MPSat]…</em> menu.
</div></li>
<li class="level"><div class="li">
 In <em>MPSat settings</em> set the <em>Mode</em> into <em><abbr title="Signal Transition Graph">STG</abbr> reachability analysis</em> and the <em>Solution</em> into <em>minimise cost function</em>.
</div></li>
<li class="level"><div class="li">
 Enter a Reach predicate specifying the short-circuit condition: both <code><span style='color:blue; '>gp</span></code> and <code><span style='color:blue; '>gn</span></code> signals are high – <code>$S&quot;gp&quot; &amp; $S&quot;gn&quot;</code>. Here <code>$S</code> means the value of a signal, <code>&quot;gp&quot;</code> and <code>&quot;gn&quot;</code> are the names of the signals and <code>&amp;</code> is Boolean AND.
</div></li>
<li class="level"><div class="li">
 Select <em>unsatisfiable</em> to denote that the property holds if predicate is unsatisfiable.
</div></li>
<li class="level"><div class="li">
 Save this property as a preset for future use, e.g. under the name <em>short circuit check</em>.
</div></li>
</ul>


<p>
The whole custom property window should look as follows.
</p>

<p>
<img src="buck-short_circuit-property_dialog.png" class="mediacenter" alt="" />
</p>

<p>
When you click the <em>Run</em> button the <abbr title="Signal Transition Graph">STG</abbr> will be searched for a state where the Reach predicate evaluates to <em>True</em>. If such a state exists then the Reach predicate is satisfiable and the property is violated; else the property holds. If the property is violated then a trace leading to a problematic state is reported. This trace can be simulated to diagnose the problem and correct it at the level of <abbr title="Signal Transition Graph">STG</abbr> specification. The <em>minimise cost function</em> setting ensures that this violation trace is as short as possible, which helps debugging.  
</p>

<p>
Note that the property that signals <code><span style='color:blue; '>gp</span></code> and <code><span style='color:blue; '>gn</span></code> are never high at the same time is not sufficient to guarantee the absence of short-circuits. Indeed, the PMOS and NMOS transistors are big and slow, and so if e.g. <code><span style='color:blue; '>gp+</span></code> happens immediately after <code><span style='color:blue; '>gn-</span></code>, a transient short-circuit may be possible even though the property holds. In fact, the signals <code><span style='color:red; '>gp_ack</span></code> and <code><span style='color:red; '>gn_ack</span></code> were introduced specifically to detect the completion of the switching of the corresponding transistors, making it possible to avoid such short-circuits. Hence, a stronger correctness property ensuring that <code><span style='color:blue; '>gp</span></code> cannot be high whenever <code><span style='color:blue; '>gn</span></code> or <code><span style='color:red; '>gn_ack</span></code> is high, and similarly <code><span style='color:blue; '>gn</span></code> cannot be high whenever <code><span style='color:blue; '>gp</span></code> or <code><span style='color:red; '>gp_ack</span></code> is high, can be formulated as <code>($S&quot;gp&quot; | $S&quot;gp_ack&quot;) &amp; ($S&quot;gn&quot; | $S&quot;gn_ack&quot;)</code>, where <code>|</code> is Boolean OR. Verify that this stronger property also holds for the above <abbr title="Signal Transition Graph">STG</abbr> model.
</p>

</div>

<h2 id="exercise_3synthesis">Exercise 3: Synthesis</h2>
<div class="level2">

<p>
The <abbr title="Signal Transition Graph">STG</abbr> specification can now be synthesised into an asynchronous circuit implementation either with MPSat or Petrify back-end tools via <em>Synthesis</em> menu. For example, the following Petrify&#039;s complex-gate implementation can be obtained by choosing <em>Synthesis→Complex gate [Petrify]</em>:
</p>

<p>
<img src="buck-cg.circuit.svg" width="201" height="105" class="svgscaleinsert mediacenter" alt="tutorial:synthesis:buck:buck-cg.circuit.svg">
</p>

<p>
Note that the solution is not unique and you may get a slightly different one. In particular, instead of the NOR gate Petrify is likely to output an AND gate with three input ‘bubbles’ – this can be fixed by right-clicking the gate and selecting <em>Propagate inversion through gate</em> from the popup menu. Save this circuit with the name <em>buck-cg-petrify.circuit.work</em>. 
</p>
<div class="wrap_center wrap_round wrap_info plugin_wrap" style="width: 90%;">
<p>
Workcraft can export circuits in the Verilog format via the <em>File→Export→.v (Workcraft Verilog serialiser).</em> Note that a complex-gate implementation is independent on the technology library, i.e. its gates are not mapped to any library gates.
</p>
</div>
</div>

<h2 id="exercise_4validation_and_formal_verification_of_implementation">Exercise 4: Validation and formal verification of implementation</h2>
<div class="level2">

</div>

<h3 id="validation1">Validation</h3>
<div class="level3">

<p>
Activate the <strong>simulation tool</strong> <img src="../../../help/core/editor_tools-simulate.png" class="media" title="[M] Simulate" alt="[M] Simulate" /> and simulate the captured complex gate implementation of the buck control. Ports, pins and wires are colour-coded: blue means low level and red means high level of the signal. Excited pins and ports are highlighted in orange.
</p>
<div class="wrap_center wrap_round wrap_important plugin_wrap" style="width: 90%;">
<p>
Make sure that the initial values of all signals are as expected: <code><span style='color:blue; '>gn</span></code> and <code><span style='color:red; '>gn_ack</span></code> must be high, and the other signals must be low. Incorrect initial values of signals is a very common problem in manually edited circuits!
</p>

<p>
Gate outputs should normally not be excited at the initial state, and at the <abbr title="Signal Transition Graph">STG</abbr> level output and internal signals should normally not be enabled by the initial marking. The reason is that most asynchronous circuits produce outputs in response to input stimuli, and are otherwise quiescent. The exceptions are circuits like oscillators.
</p>

<p>
Note however that in some synthesis modes where signal insertion is required (e.g. CSC resolution or logic decomposition with technology mapping) some of the newly inserted signals can be initially enabled, and the corresponding gates initially excited. In such a case the designer can change the initial marking of the system by firing these signals, until a quiescent initial marking is reached – this is always possible provided the initial marking of the original <abbr title="Signal Transition Graph">STG</abbr> was quiescent. Maybe, one day the tools will do that automatically…
</p>
</div>
<p>
Click an excited pin to toggle its logical value – the circuit will evaluate to the next state where new set of signals will be enabled. The sequence of signal events is recorded in the simulation trace and can be subsequently replayed for analysing the circuit&#039;s behaviour.
</p>
<div class="wrap_center wrap_round wrap_tip plugin_wrap" style="width: 90%;">
<p>
During simulation the user is not bound by the contract specified by the original <abbr title="Signal Transition Graph">STG</abbr>: The input ports are always excited and one can produce an input that would not be permitted by the <abbr title="Signal Transition Graph">STG</abbr>. Hence the circuit may exhibit non-persistent behaviour and other problems that cannot occur in a correct environment. This is intentional, i.e. not a bug but a feature!
</p>
</div>
</div>

<h3 id="formal_verification1">Formal verification</h3>
<div class="level3">
<div class="wrap_center wrap_round wrap_tip plugin_wrap" style="width: 90%;">
<p>
For the formal verification the behaviour of the environment must be specified. For a circuit synthesised by Workcraft from an <abbr title="Signal Transition Graph">STG</abbr> this <abbr title="Signal Transition Graph">STG</abbr> is automatically set as the environment. This can be checked (and changed if necessary) by activating the <strong>selection tool</strong> <img src="../../../help/core/editor_tools-select.png" class="media" title="[S] Select" alt="[S] Select" />, making sure that nothing is selected, and inspecting the <em>Environment</em> property in the Property editor. If the file does not exist then its name is shown in red.
</p>
</div>
<p>
Verify that the circuit conforms to the environment specification, is free from deadlocks and output persistent. All these verification steps can be run via <em>Verification→Conformation, deadlock freeness, output persistency (reuse unfolding) [MPSat]</em> menu.
</p>
<div class="wrap_center wrap_round wrap_important plugin_wrap" style="width: 90%;">
<p>
In theory, synthesised circuits are correct-by-construction. In practice, the synthesis tools are very complicated and may have bugs, so formally verifying the circuits is essential. This is especially true if the circuit was edited manually.
</p>
</div>
</div>

<h2 id="exercise_5alternative_implementations_optional">Exercise 5: Alternative implementations (optional)</h2>
<div class="level2">

<p>
When synthesising a complex-gate implementation with MPSat (via <em>Complex gate [MPSat]</em> menu) the circuit looks as follows (after some manual editing):
</p>

<p>
<img src="buck-cg-feedback.circuit.svg" width="195" height="123" class="svgscaleinsert mediacenter" alt="tutorial:synthesis:buck:buck-cg-feedback.circuit.svg">
</p>

<p>
Note that the gate computing <code><span style='color:blue; '>gp</span></code> now has feedback, which suggests that it may be advantageous to implement <code><span style='color:blue; '>gp</span></code> by a latch (i.e. a state-holding element) rather than a combinational gate. Below we explore some such implementations.
</p>

</div>

<h3 id="standard-c_implementation">Standard-C implementation</h3>
<div class="level3">

<p>
The <em>standard-C architecture</em> (a.k.a. <em>“monotonic covers”</em>) is shown in the picture below. It uses a C-element as the state-holding element that is driven by two combinational gates computing the <em>Set</em> and (inverted) <em>Reset functions</em> of the implemented signal. The Set and Reset functions are <em>mutually exclusive,</em> i.e. they are never 1 at the same time; hence, due to the Reset function being inverted, the inputs of the C-element cannot be 10 (combinations 00, 01, and 11 are possible).
</p>

<p>
<img src="standard-c-architecture.circuit.svg" width="133" height="146" class="svgscaleinsert mediacenter" alt="tutorial:synthesis:buck:standard-c-architecture.circuit.svg">
</p>

<p>
The standard-C implementation of the buck <abbr title="Signal Transition Graph">STG</abbr> can be synthesised using <em>Synthesis→Standard C-element [MPSat]</em> menu. By inspecting the resulting circuit (not shown) one can see that:
</p>
<ul>
<li class="level"><div class="li">
 There is no benefit in implementing <code><span style='color:blue; '>gn</span></code> using standard-C architecture, as the original complex-gate implementation is simpler. (In some situations, e.g. if there are only 2-input gates/latches in the gate library, this standard-C implementation may come useful.)
</div></li>
<li class="level"><div class="li">
 The standard-C implementation of <code><span style='color:blue; '>gp</span></code> is nicer than the complex-gate one, in particular it does away with that ugly 4-input gate that may be absent from the gate library.
</div></li>
</ul>


<p>
By selecting the complex-gate implementation of <code><span style='color:blue; '>gn</span></code> and the standard-C one of <code><span style='color:blue; '>gp</span></code> the following hybrid circuit is obtained:
</p>

<p>
<img src="buck-cg-decomposed-monot.circuit.svg" width="217" height="116" class="svgscaleinsert mediacenter" alt="tutorial:synthesis:buck:buck-cg-decomposed-monot.circuit.svg">
</p>
<div class="wrap_center wrap_round wrap_important plugin_wrap" style="width: 90%;">
<p>
Do not forget to verify this circuit w.r.t. the original <abbr title="Signal Transition Graph">STG</abbr> as described above for the complex-gate implementation!
</p>
</div>
</div>

<h3 id="logic_decomposition_and_technology_mapping">Logic decomposition and technology mapping</h3>
<div class="level3">

<p>
Complex-gate and standard-C syntheses are oblivious to the gate library – the implementations they yield are Boolean functions of arbitrary complexity. These functions are often too large to be implemented by a single gate available in the gate library. Unfortunately, breaking up a complex-gate into smaller ones, when performed naïvely, generally yields an incorrect circuit – this happens due to the delays associated with the outputs of the newly introduced gates. In fact, logic decomposition in the context of speed-independent circuits is a very difficult problem, that cannot always be solved. Petrify and MPSat backend tools do a good job in many situations, but occasionally they fail to converge to a solution and a manual intervention by the designer is required.
</p>
<div class="wrap_center wrap_round wrap_tip plugin_wrap" style="width: 90%;">
<p>
Workcraft provides several gate libraries in the <em>SIS genlib</em> format, and the user can easily add a new library. 
The default library is <code>workcraft.lib</code>, and this library will be used below. However, it is possible to tell Workcraft to use another library by amending the <em>Gate library for technology mapping</em> setting in the <em>Edit→Preferences…</em> window under the <em>Digital Circuit</em> leaf. 
</p>
</div>
<p>
The decomposed and mapped implementation of the buck <abbr title="Signal Transition Graph">STG</abbr> can be synthesised using <em>Synthesis→Technology mapping [Petrify]</em> or <em>Synthesis→Technology mapping [MPSat]</em> menu. E.g. Petrify&#039;s solution, after some manual editing, is as follows (<span class="wrap_important ">note that the solution is not unique and you may get a slightly different one</span>):
</p>

<p>
<img src="buck-mapped-pfy-wc.circuit.svg" width="283" height="183" class="svgscaleinsert mediacenter" alt="tutorial:synthesis:buck:buck-mapped-pfy-wc.circuit.svg">
</p>

<p>
The circuit is now mapped – the gate labels correspond to the gate names in the library. The two inverters are shown with a dotted line through – this is because they have the <em>Zero delay</em> property expressing the assumption that their delays are negligible. This is usually unproblematic as long as such input inverters are placed next to the main gate, but in some situations this assumption may be questionable; moreover, this assumption introduces extra constraints that have to be satisfied during placing and routing.
</p>

<p>
Let us try to decompose the implementation of <code><span style='color:blue; '>gp</span></code> into gates/latches with at most two inputs. In the <em>Edit→Preferences</em> dialog, select <em>External tools→MPSat synthesis</em> and tick the <em>Edit additional parameters before every call</em> checkbox. Then select <em>Synthesis→Technology mapping [MPSat]</em>. A dialog box will pop up asking for extra command line parameters to pass to MPSat – type <code>-g2</code> to restrict MPSat to gates/latches with at most two inputs. The following implementation of <code><span style='color:blue; '>gp</span></code> can then be computed (<span class="wrap_important ">note that solution is not unique and you may get a slightly different one</span>).
</p>

<p>
<img src="buck-deco2-wc.circuit.svg" width="195" height="133" class="svgscaleinsert mediacenter" alt="tutorial:synthesis:buck:buck-deco2-wc.circuit.svg">
</p>
<div class="wrap_center wrap_round wrap_info plugin_wrap" style="width: 90%;">
<p>
MPSat also finds a decomposition of <code><span style='color:blue; '>gn</span></code> into 2-input gates/latches (as the <code>-g2</code> option prevents it from using the a 3-input NOR gate), which is essentially the same as the standard-C implementation considered above (but it is now mapped). However, the implementation of <code><span style='color:blue; '>gn</span></code> as a 3-input NOR gate is superior and thus has been retained in the above circuit.
</p>
</div>
<p>
This solution happens to have no input inverters, and so no timing assumptions have to be made. Verify this circuit w.r.t. the original <abbr title="Signal Transition Graph">STG</abbr> as described above for the complex-gate implementation.
</p>
<div class="wrap_center wrap_round wrap_tip plugin_wrap" style="width: 90%;">
<p>
Note that this implementation of <code><span style='color:blue; '>gp</span></code> is not a standard-C implementation, as the signals on the inputs of the C-element are not mutually exclusive (even with inversions taken into account): All four possible combinations of these two values are reachable, i.e. these signals cannot be interpreted as Set and (inverted) Reset functions.
</p>
</div><div class="wrap_center wrap_round wrap_important plugin_wrap" style="width: 90%;">
<p>
Do not forget to un-tick the <em>Edit additional parameters before every call</em> checkbox (unless you want to be prompted for extra parameters every time MPSat synthesis is invoked).
</p>
</div>
</div>

<h2 id="solutions">Solutions</h2>
<div class="level2">

<p>
Download all the Workcraft models discussed in this tutorial here:
</p>

<p>
<span class="wrap_download "><a href="buck.zip" class="media mediafile mf_zip" title="tutorial:synthesis:buck:buck.zip (88.3 KB)">Buck control models</a> (88 KiB)</span>
</p>

</div>
<div class="level1">
<div class="plugin_include_content plugin_include__tutorial:feedback" id="plugin_include__tutorial__feedback">
<div class="wrap_hide plugin_wrap"><pre class="code">===== Feedback =====</pre>
<form class="bureaucracy__plugin" id="bureaucracy__plugin1" enctype="multipart/form-data" method="post" action="start.html" accept-charset="utf-8"><div class="no">
<input type="hidden" name="sectok" value="e8ce0b2f48c09a60940b0543b6d11f28" /><input type="hidden" name="id" value="tutorial:synthesis:buck:start" /><input type="hidden" name="bureaucracy[$$id]" value="1" /><fieldset ><legend>Comments or suggestions for improving this tutorial</legend>
<label><span>Name (optional)</span> <input type="text" name="bureaucracy[1]" class="edit" /></label>
<label><span>Email (optional)</span> <input type="text" name="bureaucracy[2]" class="edit" /></label>
<label class=" textareafield">
    <span>Feedback <sup>*</sup></span>
    <textarea name="bureaucracy[3]" id="" rows="10" cols="10" class="edit required&quot; required=&quot;required"></textarea>
</label><button type="submit">Submit</button>
</fieldset>
</div></form>
</div><div class="wrap_hide plugin_wrap"><ul>
<li class="level"><div class="li">
 As discussed in <a href="https://www.dokuwiki.org/plugin:include#controlling_header_size_in_included_pages" class="urlextern" title="https://www.dokuwiki.org/plugin:include#controlling_header_size_in_included_pages" rel="nofollow">https://www.dokuwiki.org/plugin:include#controlling_header_size_in_included_pages</a>, by default, the headers in included pages start one level lower than the last header in the current page. This can be tweaked by adding an empty header above the include:\\<pre class="code">====== ======
{{page&gt;:tutorial:feedback&amp;inline}}</pre>

<p>

</div></li>
<li class="level"><div class="li">
 For offline help generation the content of <code>feedback</code> page should be temporary wrapped in <code>&lt;WRAP hide&gt;</code>. Note that the headers still propagate to the table of contents even if inside the hidden wrap. Therefore the <strong>Feedback</strong> title needs to be converted to something else, e.g. to code by adding two spaces in front.
</p>

</div></li>
</ul>

</div></div>

</div>

                    <!-- wikipage stop -->
                                    </div>
<!--
                                    <div class="docInfo"><bdi>tutorial/synthesis/buck/start.txt</bdi> · Last modified: 2018/10/31 21:22 by <bdi>danil</bdi></div>
                -->

                            </div></div><!-- /content -->

            <hr class="a11y" />

            <!-- PAGE ACTIONS -->
<!--
            <div id="dokuwiki__pagetools">
                            <h3 class="a11y">Page Tools</h3>
                <div class="tools">
                    <ul>
                        <li><a href="start.html"  class="action edit" accesskey="e" rel="nofollow" title="Edit this page [E]"><span>Edit this page</span></a></li><li><a href="start.html"  class="action revs" accesskey="o" rel="nofollow" title="Old revisions [O]"><span>Old revisions</span></a></li><li><a href="start.html"  class="action backlink" rel="nofollow" title="Backlinks"><span>Backlinks</span></a></li><li class="plugin_move_page"><a href="start.html"><span>Rename Page</span></a></li><li><a href="#dokuwiki__top"  class="action top" accesskey="t" rel="nofollow" title="Back to top [T]"><span>Back to top</span></a></li><li><a href="start.html"  class="action siteexport_addpage" title="Export Page (Siteexport)"><span>Export Page</span></a></li><li><a href="javascript:void(0);" class="fold_unfold_all" onclick="fold_unfold_all();" rel="nofollow" title="Fold/unfold all"><span>Fold/unfold all</span></a></li><li><a href="start.html"  class="action siteexport_mapid" title="Show Map-ID"" data-mapid="start" onclick="copyMapIDToClipBoard.call(this); return false;"><span>Copy Map-ID: <span class="mapID" data-done="Done.">start</span></span></a></li>                    </ul>
                </div>
                        </div>
-->
        </div><!-- /wrapper -->

        
<!-- ********** FOOTER ********** -->
<div id="dokuwiki__footer"><div class="pad">
<!--
    
    <div class="buttons">
                <a href="http://www.dokuwiki.org/donate" title="Donate" ><img
            src="../../lib/tpl/dokuwiki-light-export/images/button-donate.gif" width="80" height="15" alt="Donate" /></a>
        <a href="http://php.net" title="Powered by PHP" ><img
            src="../../lib/tpl/dokuwiki-light-export/images/button-php.gif" width="80" height="15" alt="Powered by PHP" /></a>
        <a href="http://validator.w3.org/check/referer" title="Valid HTML5" ><img
            src="../../lib/tpl/dokuwiki-light-export/images/button-html5.png" width="80" height="15" alt="Valid HTML5" /></a>
        <a href="http://jigsaw.w3.org/css-validator/check/referer?profile=css3" title="Valid CSS" ><img
            src="../../lib/tpl/dokuwiki-light-export/images/button-css.png" width="80" height="15" alt="Valid CSS" /></a>
        <a href="http://dokuwiki.org/" title="Driven by DokuWiki" ><img
            src="../../lib/tpl/dokuwiki-light-export/images/button-dw.png" width="80" height="15" alt="Driven by DokuWiki" /></a>
    </div>
    <div class="userInfo">
        Logged in as:: danil    </div>
-->
</div></div><!-- /footer -->

    </div></div><!-- /site -->

    <div class="no"><img  width="2" height="1" alt="" /></div>
    <div id="screen__mode" class="no"></div></body>
</html>
