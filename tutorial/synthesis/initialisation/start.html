<!DOCTYPE html>
<html lang="en" dir="ltr" class="no-js">
<head>
    <meta charset="utf-8" />
    <title>tutorial:synthesis:initialisation:start - Workcraft</title>
    <script>(function(H){H.className=H.className.replace(/\bno-js\b/,'js')})(document.documentElement)</script>
    <meta name="generator" content="DokuWiki"/>
<meta name="robots" content="noindex,nofollow"/>
<meta name="keywords" content="tutorial,synthesis,initialisation,start"/>
<link rel="search" type="application/opensearchdescription+xml" href="../../lib/exe/opensearch.html" title="Workcraft"/>
<link rel="start" href="start.html"/>
<link rel="contents" href="start.html" title="Sitemap"/>
<link rel="alternate" type="application/rss+xml" title="Changes" />
<link rel="alternate" type="application/rss+xml" title="Current namespace" />
<link rel="edit" title="Edit this page" href="start.html"/>
<link rel="alternate" type="text/html" title="Plain HTML" href="../../_export/xhtml/tutorial/synthesis/initialisation/start.xhtml"/>
<link rel="alternate" type="text/plain" title="Wiki Markup" href="../../_export/raw/tutorial/synthesis/initialisation/start.raw"/>
<link rel="canonical" href="https://workcraft.org/tutorial/synthesis/initialisation/start"/>
<link rel="stylesheet" type="text/css" href="../../lib/exe/css.php.t.dokuwiki-light-export.css"/>
<!--[if gte IE 9]><!-->
<script type="text/javascript">/*<![CDATA[*/var NS='tutorial:synthesis:initialisation';var SIG=' --- //[[danilovesky@gmail.com|Danil Sokolov]] 2018/10/31 22:46//';var JSINFO = {"id":"tutorial:synthesis:initialisation:start","namespace":"tutorial:synthesis:initialisation","fastwiki":{"secedit":1,"preview":1,"fastpages":1,"save":0,"fastshow":0,"fastshow_same_ns":1,"fastshow_include":"","fastshow_exclude":"","preload":false,"preload_head":"====47hsjwycv782nwncv8b920m8bv72jmdm3929bno3b3====","preload_batchsize":false,"preload_per_page":false,"locktime":840,"usedraft":1,"text_btn_show":"Show page","templatename":"dokuwiki-light-export"},"act":"show","ajax":"ajax","move_renameokay":true,"plugin_slider":{"width":800,"mode":"horizontal","infiniteLoop":true,"hideControlOnEnd":false,"speed":500,"easing":null,"slideMargin":0,"startSlide":0,"randomStart":false,"captions":false,"ticker":false,"tickerHover":false,"adaptiveHeight":false,"adaptiveHeightSpeed":500,"video":false,"useCSS":true,"preloadImages":"visible","responsive":true,"pager":true,"pagerType":"full","pagerShortSeparator":"\/","controls":true,"nextText":"Next","prevText":"Prev","autoControls":false,"startText":"Start","stopText":"Stop","autoControlsCombine":false,"auto":false,"pause":4000,"autoStart":true,"autoDirection":"next","autoHover":false,"autoDelay":0,"minSlides":1,"maxSlides":1,"moveSlides":0,"slideWidth":0,"touchEnabled":true,"swipeThreshold":50,"oneToOneTouch":true,"preventDefaultSwipeX":true,"preventDefaultSwipeY":false},"plugin_folded":{"hide":"hide","reveal":"reveal"}};
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="../../lib/exe/jquery.php.t.dokuwiki-light-export.js"></script>
<script type="text/javascript" charset="utf-8" src="../../lib/exe/js.php.t.dokuwiki-light-export.js"></script>
<!--<![endif]-->
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="shortcut icon" href="../../favicon.ico" />
<link rel="apple-touch-icon" href="../../apple-touch-icon.png" />
    </head>

<body>
    <div id="dokuwiki__site"><div id="dokuwiki__top" class="site dokuwiki mode_show tpl_dokuwiki-light-export loggedIn    ">

        
<!-- ********** HEADER ********** -->
<div id="dokuwiki__header"><div class="pad group">

        <h1><a href="../../start.html"  title="Workcraft start page"><img src="../../logo.png" width="327" height="57" alt="" /></a></h1>
    
    <div class="tools group">
        <!-- USER TOOLS -->
<!--
                    <div id="dokuwiki__usertools">
                <h3 class="a11y">User Tools</h3>
                <ul>
                    <li><a href="start.html"  class="action admin" rel="nofollow" title="Admin">Admin</a></li><li><a href="start.html"  class="action profile" rel="nofollow" title="Profile">Profile</a></li><li><a href="start.html"  class="action logout" rel="nofollow" title="Log Out">Log Out</a></li>                </ul>
            </div>
        -->

        <!-- SEARCH TOOLS -->
<!--
        <div id="dokuwiki__searchtools">
            <h3 class="a11y"></h3>
            <form action="../../start.html" accept-charset="utf-8" class="search" id="dw__search" method="get" role="search"><div class="no"><input type="hidden" name="do" value="search" /><input type="text" placeholder="Search" id="qsearch__in" accesskey="f" name="id" class="edit" title="[F]" /><button type="submit" title="Search">Search</button><div id="qsearch__out" class="ajax_qsearch JSpopup"></div></div></form>        </div>
-->

        <!-- SITE TOOLS -->
<!--
        <div id="dokuwiki__sitetools">
            <h3 class="a11y">Site Tools</h3>
                            <div class="mobileTools">
                    <form action="../..//doku.html.doku.php.html" method="get" accept-charset="utf-8"><div class="no"><input type="hidden" name="id" value="tutorial:synthesis:initialisation:start" /><input type="hidden" name="sectok" value="4060e4ba06519fdbdd3a1a64f88f6b35" /><select name="do" class="edit quickselect" title="Tools"><option value="">Tools</option><optgroup label="Page Tools"><option value="edit">Edit this page</option><option value="revisions">Old revisions</option><option value="backlink">Backlinks</option></optgroup><optgroup label="Site Tools"><option value="recent">Changes</option><option value="media">Manager</option><option value="index">Sitemap</option></optgroup><optgroup label="User Tools"><option value="logout">Log Out</option><option value="profile">Profile</option><option value="admin">Admin</option></optgroup></select><button type="submit">&gt;</button></div></form>                </div>
                <ul>
                    <li><a href="start.html"  class="action recent" accesskey="r" rel="nofollow" title="Changes [R]">Changes</a></li><li><a href="start.html"  class="action media" rel="nofollow" title="Manager">Manager</a></li><li><a href="start.html"  class="action index" accesskey="x" rel="nofollow" title="Sitemap [X]">Sitemap</a></li>                </ul>
                    </div>
-->
    </div>

    <!-- BREADCRUMBS -->
<!--
    -->



    <hr class="a11y" />
</div></div><!-- /header -->

        <div class="wrapper group">

            
            <!-- ********** CONTENT ********** -->
            <div id="dokuwiki__content"><div class="pad group">
                
                <div class="pageId"><span>tutorial:synthesis:initialisation:start</span></div>

                <div class="page group">
                                                            <!-- wikipage start -->
                    <div class="plugin_fastwiki_marker" style="display:none"></div><!-- TOC START -->
<div id="dw__toc">
<h3 class="toggle">Table of Contents</h3>
<div>

<ul class="toc">
<li class="level1"><div class="li"><a href="#initialisation_analyser">Initialisation analyser</a></div></li>
<li class="level1"><div class="li"><a href="#initialisation_of_cycle_module">Initialisation of CYCLE module</a></div></li>
<li class="level1"><div class="li"><a href="#initialisation_of_charge_module">Initialisation of CHARGE module</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="#alternative_reset_insertion">Alternative reset insertion</a></div></li>
</ul>
</li>
<li class="level1"><div class="li"><a href="#cyclic_dependencies">Cyclic dependencies</a></div></li>
<li class="level1"><div class="li"><a href="#verification_of_circuits_with_initialisation">Verification of circuits with initialisation</a></div></li>
<li class="level1"><div class="li"><a href="#exporting_to_verilog">Exporting to Verilog</a></div></li>
<li class="level1"><div class="li"><a href="#solutions">Solutions</a></div></li>
</ul>
</div>
</div>
<!-- TOC END -->

<h1 id="initialisation_of_speed-independent_circuits">Initialisation of speed-independent circuits</h1>
<div class="level1">

<p>
In this tutorial we will use <code>CYCLE</code> and <code>CHARGE</code> modules developed in the <a href="../decomposition/start.html" class="wikilink1" title="tutorial:synthesis:decomposition:start">Hierarchical design of a realistic buck controller</a> tutorial. The top-level schematic of the controller is as follows:
</p>

<p>
<img src="top-level.circuit.svg" width="630" height="499" class="svgscaleinsert mediacenter" alt="tutorial:synthesis:initialisation:top-level.circuit.svg">
</p>

<p>
Circuit implementations of <code>CYCLE</code> and <code>CHARGE</code> modules and also <abbr title="Signal Transition Graph">STG</abbr> specifications of their contract with environment (which will be used for circuit verification) can be downloaded here:
</p>
<div class="wrap_center plugin_wrap"><div class="table sectionedit3"><table class="inline">
	<thead>
	<tr class="row0">
		<th class="col0 leftalign"> Module name  </th><th class="col1 centeralign">  <abbr title="Signal Transition Graph">STG</abbr> specification  </th><th class="col2 centeralign">  Circuit implementation  </th>
	</tr>
	</thead>
	<tr class="row1">
		<td class="col0 leftalign"> <code>CYCLE</code>  </td><td class="col1 centeralign">  <span class="wrap_download "><a href="cycle.stg.work" class="media mediafile mf_work" title="tutorial:synthesis:initialisation:cycle.stg.work (3.1 KB)">cycle.stg.work</a> (3 KiB)</span>   </td><td class="col2 centeralign">  <span class="wrap_download "><a href="cycle-tm.circuit.work" class="media mediafile mf_work" title="tutorial:synthesis:initialisation:cycle-tm.circuit.work (3.1 KB)">cycle-tm.circuit.work</a> (3 KiB)</span>  </td>
	</tr>
	<tr class="row2">
		<td class="col0 leftalign"> <code>CHARGE</code>  </td><td class="col1 centeralign">  <span class="wrap_download "><a href="charge.stg.work" class="media mediafile mf_work" title="tutorial:synthesis:initialisation:charge.stg.work (4.3 KB)">charge.stg.work</a> (4 KiB)</span>  </td><td class="col2 centeralign">  <span class="wrap_download "><a href="charge-tm.circuit.work" class="media mediafile mf_work" title="tutorial:synthesis:initialisation:charge-tm.circuit.work (7 KB)">charge-tm.circuit.work</a> (7 KiB)</span>  </td>
	</tr>
</table></div>
</div>
</div>
<div class="level1">
<div class="plugin_include_content plugin_include__help:circuit:initialisation" id="plugin_include__help__circuit__initialisation">

<h2 id="initialisation_analyser">Initialisation analyser</h2>

<p>
Initialisation (or reset) of a speed-independent circuit is an important part of the design process because a circuit can malfunction if its initial state is incorrect. Note that the initialisation phase of a speed-independent circuit does not have to be speed-independent: It is assumed that there is a special <code><span style='color:red; '>reset</span></code> signal that is generated externally and behaves as follows:
</p>
<ul>
<li class="level"><div class="li">
 When the power is connected, <code><span style='color:red; '>reset</span></code> is low.
</div></li>
<li class="level"><div class="li">
 It stays low for sufficiently long time to complete the initialisation of all gates.
</div></li>
<li class="level"><div class="li">
 Eventually <code><span style='color:red; '>reset</span></code> goes high, at which point the circuit is already correctly initialised and the normal speed-independent operation begins.
</div></li>
<li class="level"><div class="li">
 <code><span style='color:red; '>reset</span></code> stays high for the whole time of circuit normal operation. 
</div></li>
</ul>


<p>
There are several ways of circuit initialisation that can be used in combination:
</p>
<ul>
<li class="level"><div class="li">
 Rely on the initial state of some of the inputs (which are guaranteed to be correctly initialised by the environment). They propagate through some of the logic gates to initialise some of the internal and output signals.
</div></li>
<li class="level"><div class="li">
 Substitute some of the gates with ones containing an extra input that can act as a set or reset pin.
</div></li>
<li class="level"><div class="li">
 Insert additional gates to explicitly initialise the internal and output signals. Such gates will act as buffers during the normal operation, so one has to be careful not to break any <em>isochronic forks</em>.
</div></li>
</ul>


<p>
<em>Initialisation analyser</em> <img src="../../../help/circuit/editor_tools-initialisation_analysis.png" class="media" title="[I] Initialisation analyser" alt="[I] Initialisation analyser" /> tool is designed to aid the decision of how to reset these modules. The tool uses <em>Init to one</em> and <em>Forced init</em> properties of circuit signals (i.e. primary input ports and output pins of circuit components):
</p>
<ul>
<li class="level"><div class="li">
 <em>Init to one</em> property defines the initial state of the signal. If a circuit is synthesised by one of the backend tools, then the initial state of all its signals is set automatically. However, if the circuit is manually altered, then the designer is responsible for specifying the initial states of the signals.
</div></li>
</ul>

<ul>
<li class="level"><div class="li">
 <em>Forced init</em> property defines if the signal is known to be in a correct initial state. For a primary input it means the environment takes care of initialising the signal to its expected state.  For a  component output pin it means that the necessary circuitry will be added to properly initialise that pin.
</div></li>
</ul>


<p>
These properties can be viewed and modified in the <em>Property editor</em> when an input port or an output pin is selected. Note that selecting a single-output component (i.e. a gate) also reveals these properties of its only output pin.
</p>

<p>
<em>Initialisation analyser</em> uses these properties as follows. It considers the signals whose <em>Forced init</em> property is set as <em>initialised</em>, while the remaining signals are assumed as <em>uninitialised</em>. The tool tries to evaluate each <em>uninitialised</em> signal on the <em>Init to one</em> property of <em>initialised</em> signals. If the Boolean value of a signal can be derived, then it is said to have <em>propagated initial state</em> and the signal is also considered <em>initialised</em>. The tool repeats evaluation of <em>uninitialised</em> signals until no further progress can be made, i.e. no new <em>initialised</em> signals can be obtained. At this stage, if some signals are still <em>uninitialised</em> it means <em>Forced init</em> property of the circuit signals needs to be adjusted, until all the signals are successfully initialised. 
</p>

<p>
If the propagated initial state of a signal does not match its <em>Init to one</em> property, then the signal is said to have <em>initialisation conflict</em> – this often indicates a mistake, e.g. incorrect initial value of the signal. However, there are legitimate situations where such conflicts can occur – most likely such a signal needs to be explicitly initialised by setting its <em>Forced init</em> property.
</p>

<p>
<em>Initialisation analyser</em> visualises the initialisation state using the <em>Gate highlight legend</em> shown in the <em>Tool controls</em>:
</p>

<p>
<img src="../../../help/circuit/tool_controls-initialisation.png" class="mediacenter" alt="" />
</p>

<p>
By default the highlighting scheme is as follows (the colours can be adjusted in the preferences of digital circuit model – see <em>Edit→Preferences…→Models→Digital Circuit</em>):
</p>
<ul>
<li class="level1"><div class="li"> The wires and pins of <em>initialised</em> signals are coloured <span style='color:red; '>red</span> (if <em>Init to one</em> property is set) or <span style='color:blue; '>blue</span> (if <em>Init to one</em> is not set). Wires and pins of <em>uninitialised</em> signals are coloured black.</div>
</li>
<li class="level1"><div class="li"> Components whose initial state cannot be determined via propagation of <em>forced</em> signals are not highlighted (i.e. remain white).</div>
</li>
<li class="level1"><div class="li"> In case of initialisation conflicts, the problematic gates are highlighted <span style='color:magenta; '> magenta</span>.</div>
</li>
<li class="level1"><div class="li"> Output pins whose <em>Forced init</em> property is set are visualised by diamond shape and their components  are highlighted <span style='color:orange; '>orange</span>.</div>
</li>
<li class="level1"><div class="li"> Correctly initialised components are highlighted <span style='color:lime; '>green</span>.</div>
</li>
</ul>

<p>
<em>Force init pins</em> table enumerates the pins whose <em>Forced init</em> property is set. Note that <em>Forced init</em> property of a signal can be toggled while in <em>Initialisation analyser</em> tool by clicking the corresponding input port, output pin, or a gate. This enables convenient exploration of possible reset strategies. The tool also provides several ways of changing <em>Force init</em> property for a group of contacts:
</p>
<ul>
<li class="level"><div class="li">
 <img src="../../../help/circuit/tool_controls-initialisation-clear_all.png" class="media" title="Clear force init from all input ports and component outputs" alt="Clear force init from all input ports and component outputs" /> - Unset <em>Forced init</em> property for all input ports and component outputs.
</div></li>
<li class="level"><div class="li">
 <img src="../../../help/circuit/tool_controls-initialisation-input_port.png" class="media" title="Toggle force init for all input ports (environment responsibility)" alt="Toggle force init for all input ports (environment responsibility)" /> - Toggle <em>Forced init</em> property for all input ports. Note that it is the environment responsibility to guarantee the correct initialisation of primary inputs whose <em>Forced init</em> property is set.
</div></li>
<li class="level"><div class="li">
 <img src="../../../help/circuit/tool_controls-initialisation-self_loop.png" class="media" title="Toggle force init for all self-loops" alt="Toggle force init for all self-loops" /> - Toggle <em>Forced init</em> property for all component outputs with self-loops.
</div></li>
<li class="level"><div class="li">
 <img src="../../../help/circuit/tool_controls-initialisation-sequential_gate.png" class="media" title="Toggle force init for all sequential gates" alt="Toggle force init for all sequential gates" /> - Toggle <em>Forced init</em> property for outputs of all sequential gates.
</div></li>
<li class="level"><div class="li">
 <img src="../../../help/circuit/tool_controls-initialisation-untag_redundant.png" class="media" title="Remove force init from pins if redundant for initialisation" alt="Remove force init from pins if redundant for initialisation" /> - Unset <em>Forced init</em> property of the component outputs if they are redundant for the circuit initialisation.
</div></li>
<li class="level"><div class="li">
 <img src="../../../help/circuit/tool_controls-initialisation-tag_necessary.png" class="media" title="Add force init to pins if necessary to complete initialisation" alt="Add force init to pins if necessary to complete initialisation" /> - Set <em>Forced init</em> property of component outputs as necessary to complete initialisation of the circuit.
</div></li>
</ul>


<p>
Circuit initialisation comprises three steps:
</p>
<ol>
<li class="level"><div class="li">
 <strong>Reset exploration</strong> – Decide which signals should be forced to the initial state, so that the correct initial values propagate to the remaining circuit components. Selecting a good set of forced signals is a creative process with multiple optimisation targets (avoiding critical paths, circuit size, gate complexity, etc.) and relies on designer experience.
</div></li>
<li class="level"><div class="li">
 <strong>Reset insertion</strong> – Insert the reset port <code><span style='color:red; '>reset</span></code>, set its <em>Init to one</em> property according to the reset active state (<em>false</em> for active low, <em>true</em> for active high), and use it to initialise all the signals that have <em>Force init</em> property set.
</div></li>
<li class="level"><div class="li">
 <strong>Reset validation</strong>  – Clear <em>Force init</em> property of all component pins and input ports, set <em>Force init</em> property for the reset port, and check that all the circuit components are correctly initialised.
</div></li>
</ol>

</div>

</div>

<h2 id="initialisation_of_cycle_module">Initialisation of CYCLE module</h2>
<div class="level2">

<p>
For initialisation of <code>CYCLE</code> we cannot rely on any inputs. Indeed, the <code>WAIT2</code> element on <code><span style='color:blue; '>uv_ctrl</span></code>/<code><span style='color:red; '>uv_san</span></code> interface does not have an explicit reset and the initialisation of <code>CYCLE</code> component on <code><span style='color:blue; '>chrg_req</span></code>/<code><span style='color:red; '>chrg_ack</span></code> is not yet considered. The two inverters <code>me_r1</code> and <code>me_r2</code> on the <code>MUTEX</code> inputs are good candidates for introducing reset – click both of them to indicate their force initialisation (notice the diamond shape of their forcefully initialised output pins). As the result <code>MUTEX</code> grants get initialised in their correct initial states.
</p>

<p>
<img src="cycle-tm-analysis.circuit.png" class="mediacenter" title="Initialisation of the CYCLE circuit" alt="Initialisation of the CYCLE circuit" />
</p>

<p>
Now let us alter the circuit schematic and insert active-low reset signal <code><span style='color:red; '>nrst</span></code>. This step will be automated in the future version of Workcraft, but currently we have to do it manually:
</p>
<ul>
<li class="level"><div class="li">
 Insert a new input port <code><span style='color:red; '>nrst</span></code> and make sure its initial state is low, i.e. its <em>Init to one</em> property is unchecked.
</div></li>
<li class="level"><div class="li">
 The output of inverter <code>me_r1</code> needs to be initially high. This can be achieved by replacing this inverter by a <code>NAND2</code> gate (set function for <code>ON</code> output is <code>(A*B)&#039;</code>) with one of its inputs connected to <code><span style='color:red; '>nrst</span></code>.
</div></li>
<li class="level"><div class="li">
 The output of <code>me_r2</code> inverter is initially low, therefore it should be replaced by a <code>NOR2B</code> gate (set function for <code>ON</code> output is <code>(AN&#039; + B)&#039;</code>) whose inverted input is driven by <code><span style='color:red; '>nrst</span></code>.
</div></li>
</ul>


<p>
The modified circuit should look as follows (reset wires and modified gates are coloured <span style='color:green; '>dark green</span>):
</p>

<p>
<img src="cycle-tm-reset.circuit.svg" width="352" height="195" class="svgscaleinsert mediacenter" alt="tutorial:synthesis:initialisation:cycle-tm-reset.circuit.svg">
</p>

<p>
Use <em>Initialisation analyser</em> <img src="../../../help/circuit/editor_tools-initialisation_analysis.png" class="media" title="[I] Initialisation analyser" alt="[I] Initialisation analyser" /> to check that it is sufficient to set <code><span style='color:red; '>nrst</span></code> low to force this amended <code>CYCLE</code> circuit to its initial state: Remove <em>Forced init</em> flag from <code>me_r1</code> and <code>me_r2</code> gates by clicking these gates, then click <code><span style='color:red; '>nrst</span></code> port to indicate that it is guaranteed to be low. All the gates should be highlighted in <span style='color:lime; '>green</span> indicating their correct initialisation:
</p>

<p>
<img src="cycle-tm-analysis-reset.circuit.png" class="mediacenter" title="Initialisation of the CYCLE circuit - Reset" alt="Initialisation of the CYCLE circuit - Reset" />
</p>

<p>
Also observe that when <code><span style='color:red; '>nrst</span></code> goes high the circuit becomes equivalent to the original one.
</p>
<div class="wrap_important wrap_round wrap_center plugin_wrap" style="width: 90%;">
<p>
Initialisation conflict happens when the Boolean function of the gate evaluates to a state that is different from the expected state of a signal. Such gates are highlighted in <span style='color:magenta; '>magenta</span>. For example, if in <code>CYCLE</code> module one relies on input <code><span style='color:red; '>chrg_ack</span></code> whose initial state is <code>0</code>, then the inverter <code>me_r2</code> evaluates to <code>1</code> which is different from the required initial state of this signal:
</p>

<p>
<img src="cycle-tm-analysis-conflict.circuit.png" class="mediacenter" title="Initialisation of the CYCLE circuit - Conflict" alt="Initialisation of the CYCLE circuit - Conflict" />
</p>

<p>
In such situations the problemetic gate must be explicitly initialised to the required state. The user is expected to set <em>Forced init</em> flag on such a gate by clicking it in the <em>Initialisation analysis</em> tool.
</p>
</div>
</div>

<h2 id="initialisation_of_charge_module">Initialisation of CHARGE module</h2>
<div class="level2">

<p>
For initialisation of <code>CHARGE</code> module one can already rely on <code>CYCLE</code> module 
initialising <span style='color:red; '>chrg_req</span> input to <code>0</code>. Click on this input port to 
indicate that its initial state is guaranteed by the environment. The gates which
are initialised correctly through this input will be highlighted in <span style='color:lime; '>green</span>:
</p>

<p>
<img src="charge-tm-analysis-step1.circuit.png" class="mediacenter" title="Initialisation of the CHARGE circuit - Step 1" alt="Initialisation of the CHARGE circuit - Step 1" />
</p>

<p>
There is a combinational loop in this circuit that needs explicit initialisation – the one 
with <code>_U12</code> gate. Click this gate to indicate that we will take care of explicitly 
initialising it – the gate will turn <span style='color:orange; '>orange</span> and its output pin will 
change its shape to a diamond:
</p>

<p>
<img src="charge-tm-analysis-step2.circuit.png" class="mediacenter" title="Initialisation of the CHARGE circuit - Step 2" alt="Initialisation of the CHARGE circuit - Step 2" />
</p>

<p>
Now consider C-element <code>_U5</code>. Its inputs have the opposite initial values, so 
cannot force its output to any particular value, i.e. it needs to be forced to its initial value. 
Click on this C-element to indicate explicit initialisation – it will be highlighted 
in <span style='color:orange; '>orange</span> and its output will change its shape to a diamond:
</p>

<p>
<img src="charge-tm-analysis-step3.circuit.png" class="mediacenter" title="Initialisation of the CHARGE circuit - Step 3" alt="Initialisation of the CHARGE circuit - Step 3" />
</p>

<p>
Let us see how the remaining gates can be initialised. Note that both <code><span style='color:blue; '>oc_ctrl</span></code> and <code><span style='color:blue; '>zc_ctrl</span></code> outputs are now successfully initialised to <code>0</code>. At the top level, these signals interface the <code>WAIT</code> elements that produce <code><span style='color:red; '>oc_san</span></code> and <code><span style='color:red; '>zc_san</span></code> inputs, respectively. As <code>WAIT</code> element resets its <code><span style='color:blue; '>san</span></code> output when its <code><span style='color:red; '>ctrl</span></code> input is low, signals <code><span style='color:red; '>oc_san</span></code> and <code><span style='color:red; '>zc_san</span></code> are guaranteed to be initially low – click these inputs to indicate this. Now the whole <code>CHARGE</code> module is initialised, provided that gates <code>_U5</code> and <code>_U12</code> (highlighted in <span style='color:orange; '>orange</span>) are explicitly reset:
</p>

<p>
<img src="charge-tm-analysis-step4.circuit.png" class="mediacenter" title="Initialisation of the CHARGE circuit - Step 4" alt="Initialisation of the CHARGE circuit - Step 4" />
</p>

<p>
As we found a strategy to fully initialise the <code>CHARGE</code> component, let us implement it at the gate-level. The following changes are required:
</p>
<ul>
<li class="level"><div class="li">
 Replace C-element <code>_U5</code> with a resetable C-element – change its label from <code>C2</code> to <code>C2R</code>, modify its <em>Set function</em> to <code>A * B * RN</code>, and <em>Reset function</em> to <code>(A + B)&#039; + RN&#039;</code>.
</div></li>
<li class="level"><div class="li">
 Change the type (i.e. the <em>Label</em> property) of gate <code>_U12</code> from <code>OAI22</code> to <code>OAI221</code> and modify its <em>Set function</em> to <code>((A1 + A2) * (B1 + B2) * C)&#039;</code>.
</div></li>
<li class="level"><div class="li">
 Insert a new input port <code><span style='color:red; '>nrst</span></code> whose initial state is low, i.e. <em>Init to one</em> property is not ticked.
</div></li>
<li class="level"><div class="li">
 Connect <code><span style='color:red; '>nrst</span></code> to the <code><span style='color:red; '>RN</span></code> pin of <code>_U5</code> and to the <code><span style='color:red; '>C</span></code> pin of <code>_U12</code>.
</div></li>
</ul>


<p>
The <code>CHARGE</code> component with the initialisation circuitry looks as follows (the initialisation wires and modified gates are coloured <span style='color:green; '>dark green</span>):
</p>

<p>
<img src="charge-tm-reset.circuit.svg" width="617" height="602" class="svgscaleinsert mediacenter" alt="tutorial:synthesis:initialisation:charge-tm-reset.circuit.svg">
</p>

<p>
Again, use <em>Initialisation analyser</em> <img src="../../../help/circuit/editor_tools-initialisation_analysis.png" class="media" title="[I] Initialisation analyser" alt="[I] Initialisation analyser" /> to check that all the gates are correctly initialised by forcing only <code><span style='color:red; '>nrst</span></code>, <code><span style='color:red; '>chrg_req</span></code>, <code><span style='color:red; '>oc_san</span></code>, and <code><span style='color:red; '>zc_san</span></code> inputs. For this remove <em>Forced init</em> flag from the gates <code>_U5</code> and <code>_U12</code> by clicking them; also click <code><span style='color:red; '>nrst</span></code> port to denote it is guaranteed to be low. All the gates should be highlighted in <span style='color:lime; '>green</span> indicating their correct initialisation:
</p>

<p>
<img src="charge-tm-analysis-reset.circuit.png" class="mediacenter" title="Initialisation of the CHARGE circuit - Reset" alt="Initialisation of the CHARGE circuit - Reset" />
</p>

<p>
Observe that when <code><span style='color:red; '>nrst</span></code> is high, the circuit becomes equivalent to the original one.
</p>

</div>

<h3 id="alternative_reset_insertion">Alternative reset insertion</h3>
<div class="level3">

<p>
An alternative way to reset the <code>_U5</code> C-element is by forcing both its inputs to <code>0</code>. This can be achieved by inserting an <code>AND2</code> gate (set function for <code>O</code> output is <code>A * B</code>) in the wire between <code>_U12</code> and <code>_U5</code> gates and connecting <code><span style='color:red; '>nrst</span></code> to one of its inputs:
</p>

<p>
<img src="charge-tm-reset-alt.circuit.svg" width="671" height="604" class="svgscaleinsert mediacenter" alt="tutorial:synthesis:initialisation:charge-tm-reset-alt.circuit.svg">
</p>
<div class="wrap_center wrap_round wrap_important plugin_wrap" style="width: 90%;">
<p>
It is not safe to insert a gate into a fork branch, as the fork ceases to be <em>isochronic</em> thus potentially breaking the speed-independence of the circuit. Such modifications must be verified.
</p>

<p>
Note, however, that inserting a new gate into the ‘trunk’ of a fork, before branching, is safe, as the resulting delay can be conceptually added to the delay of the driving gate.
</p>
</div>
<p>
In this particular case, a delay in the fork branch does not cause a problem – this can be checked by inserting a buffer into this branch (right-click on the wire and select <em>Insert buffer</em> command in the popup menu) and verifying that conformation, deadlock freeness, input properness, output persistency, and mutex implementability still hold. When verifying the circuit do not forget to set its <em>Environment</em> property so it points to the correct <abbr title="Signal Transition Graph">STG</abbr> specification of <code>CHARGE</code> module (this can be done via the <em>Property editor</em> of the model). As an experiment, try to delay the other branches of this fork and see if this breaks any correctness properties.
</p>

</div>

<h2 id="cyclic_dependencies">Cyclic dependencies</h2>
<div class="level2">

<p>
When initialising a circuit composed from several blocks, one has to 
make sure that there are no cyclic dependencies during the initialisation. 
</p>

<p>
For examples, <code>CYCLE</code> and <code>CHARGE</code> communicate via a handshake. Suppose <code>CYCLE</code> relies 
on its input <code><span style='color:red; '>chrg_ack</span></code> to initialise 
<code><span style='color:blue; '>chrg_req</span></code>, and <code>CHARGE</code> relies on it 
input <code><span style='color:red; '>chrg_req</span></code> to initialise <code><span style='color:blue; '>chrg_ack</span></code>.
This creates a cyclic dependency and the resulting circuit will not initialise reliably.
</p>

</div>

<h2 id="verification_of_circuits_with_initialisation">Verification of circuits with initialisation</h2>
<div class="level2">

<p>
The obtained circuits have an extra <code><span style='color:red; '>nrst</span></code> input. It is initially low and 
expected to stay low for sufficiently long to initialise all the gates into their expected initial 
states – note that the initialisation phase is not speed-independent (and not expected to be). 
When <code><span style='color:red; '>nrst</span></code> goes high, the circuit starts its normal speed-independent operation. 
</p>

<p>
This behaviour of <code><span style='color:red; '>nrst</span></code> can be modelled by editing its properties as follows:
</p>
<ul>
<li class="level"><div class="li">
 Uncheck <em>Init to one</em> property to specify that <code><span style='color:red; '>nrst</span></code> is initially low.
</div></li>
<li class="level"><div class="li">
 Assign <em>Set function</em> to <code>1</code> to denote that <code><span style='color:red; '>nrst</span></code> is only allowed to go high.
</div></li>
</ul>


<p>
Now the circuits can be verified for deadlocks, output persistency, and conformation 
to the original STGs in the usual way via <em>Verification</em> menu. Do this for 
both <code>CYCLE</code> and <code>CHARGE</code> modules.
</p>

</div>

<h2 id="exporting_to_verilog">Exporting to Verilog</h2>
<div class="level2">

<p>
Both <code>CYCLE</code> and <code>CHARGE</code> modules are mapped to a gate library and correctly initialised. Now 
they can be exported to Verilog for the remaining stages of the design flow 
using <em>File</em>→<em>Export</em>→<em>.v (Workcraft Verilog serialiser)</em> menu. Here is a 
result of exporting the <code>CYCLE</code> module:
</p>
<dl class="code">
<dt><a href="../../_export/code/tutorial/synthesis/initialisation/start/codeblock.0.code" title="Download Snippet" class="mediafile mf_v">cycle-tm-reset.v</a></dt>
<dd><pre class="code verilog"><span class="co1">// Verilog netlist generated by Workcraft 3 (Return of the Hazard), version 3.2.0</span>
<span class="kw1">module</span> CYCLE <span class="br0">&#40;</span>chrg_ack<span class="sy0">,</span> chrg_req<span class="sy0">,</span> uv_ctrl<span class="sy0">,</span> uv_san<span class="sy0">,</span> nrst<span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="kw1">input</span> chrg_ack<span class="sy0">,</span> uv_san<span class="sy0">,</span> nrst<span class="sy0">;</span>
    <span class="kw1">output</span> chrg_req<span class="sy0">,</span> uv_ctrl<span class="sy0">;</span>
&nbsp;
    NAND2 me_r1_rst <span class="br0">&#40;</span>.ON<span class="br0">&#40;</span>me_r1_rst_ON<span class="br0">&#41;</span><span class="sy0">,</span> .A<span class="br0">&#40;</span>uv_san<span class="br0">&#41;</span><span class="sy0">,</span> .B<span class="br0">&#40;</span>nrst<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    NOR2B me_r2_rst <span class="br0">&#40;</span>.ON<span class="br0">&#40;</span>me_r2_rst_ON<span class="br0">&#41;</span><span class="sy0">,</span> .AN<span class="br0">&#40;</span>nrst<span class="br0">&#41;</span><span class="sy0">,</span> .B<span class="br0">&#40;</span>chrg_ack<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    MUTEX me <span class="br0">&#40;</span>.r1<span class="br0">&#40;</span>me_r1_rst_ON<span class="br0">&#41;</span><span class="sy0">,</span> .g1<span class="br0">&#40;</span>uv_ctrl<span class="br0">&#41;</span><span class="sy0">,</span> .r2<span class="br0">&#40;</span>me_r2_rst_ON<span class="br0">&#41;</span><span class="sy0">,</span> .g2<span class="br0">&#40;</span>chrg_req<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
    <span class="co1">// signal values at the initial state:</span>
    <span class="co1">// me_r1_rst_ON !me_r2_rst_ON uv_ctrl !chrg_req !chrg_ack !uv_san !nrst</span>
<span class="kw1">endmodule</span></pre>
</dd></dl>

<p>
The produced Verilog inherits the names of gates and pins as they are defined in the <em>Property editor</em> for the corresponding nodes. The specifications of these gates are taken by the technology mapping backend from the <code>library/workcraft.lib</code> GenLib file by default. A custom GenLib file can be supplied via <em>Digital Circuit</em>→<em>Gate library for technology mapping</em> property of global settings (accessible via <em>Edit</em>→<em>Preferences…</em> menu). 
</p>

<p>
These names can also be substituted by providing a conversion file in the <em>Digital Circuit</em>→<em>Substitution rules for export</em> property of global preferences. For example, <code>libraries/workcraft-tsmc_ghp.cnv</code> file has the rules to convert <code>librarys/workcraft.lib</code> gates to match the naming convention of TSMC GHP library. For <code>CYCLE</code> module the produced TSMC-compatible Verilog is as follows:
</p>
<dl class="code">
<dt><a href="../../_export/code/tutorial/synthesis/initialisation/start/codeblock.1.code" title="Download Snippet" class="mediafile mf_v">cycle-tm-reset-tsmc.v</a></dt>
<dd><pre class="code verilog"><span class="co1">// Verilog netlist generated by Workcraft 3 (Return of the Hazard), version 3.2.0</span>
<span class="kw1">module</span> CYCLE <span class="br0">&#40;</span>chrg_ack<span class="sy0">,</span> chrg_req<span class="sy0">,</span> uv_ctrl<span class="sy0">,</span> uv_san<span class="sy0">,</span> nrst<span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="kw1">input</span> chrg_ack<span class="sy0">,</span> uv_san<span class="sy0">,</span> nrst<span class="sy0">;</span>
    <span class="kw1">output</span> chrg_req<span class="sy0">,</span> uv_ctrl<span class="sy0">;</span>
&nbsp;
    ND2D1 me_r1_rst <span class="br0">&#40;</span>.ZN<span class="br0">&#40;</span>me_r1_rst_ON<span class="br0">&#41;</span><span class="sy0">,</span> .A1<span class="br0">&#40;</span>uv_san<span class="br0">&#41;</span><span class="sy0">,</span> .A2<span class="br0">&#40;</span>nrst<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    INR2D1 me_r2_rst <span class="br0">&#40;</span>.ZN<span class="br0">&#40;</span>me_r2_rst_ON<span class="br0">&#41;</span><span class="sy0">,</span> .A1<span class="br0">&#40;</span>nrst<span class="br0">&#41;</span><span class="sy0">,</span> .B1<span class="br0">&#40;</span>chrg_ack<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    MUTEX me <span class="br0">&#40;</span>.r1<span class="br0">&#40;</span>me_r1_rst_ON<span class="br0">&#41;</span><span class="sy0">,</span> .g1<span class="br0">&#40;</span>uv_ctrl<span class="br0">&#41;</span><span class="sy0">,</span> .r2<span class="br0">&#40;</span>me_r2_rst_ON<span class="br0">&#41;</span><span class="sy0">,</span> .g2<span class="br0">&#40;</span>chrg_req<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
    <span class="co1">// signal values at the initial state:</span>
    <span class="co1">// me_r1_rst_ON !me_r2_rst_ON uv_ctrl !chrg_req !chrg_ack !uv_san !nrst</span>
<span class="kw1">endmodule</span></pre>
</dd></dl>

</div>

<h2 id="solutions">Solutions</h2>
<div class="level2">

<p>
Download all the Workcraft models discussed in this tutorial here:
</p>

<p>
<span class="wrap_download "><a href="initialisation.zip" class="media mediafile mf_zip" title="tutorial:synthesis:initialisation:initialisation.zip (36 KB)">Circuit models</a> (36 KiB)</span>
</p>

</div>
<div class="level1">
<div class="plugin_include_content plugin_include__tutorial:feedback" id="plugin_include__tutorial__feedback">
<div class="wrap_hide plugin_wrap"><pre class="code">===== Feedback =====</pre>
<form class="bureaucracy__plugin" id="bureaucracy__plugin1" enctype="multipart/form-data" method="post" action="start.html" accept-charset="utf-8"><div class="no">
<input type="hidden" name="sectok" value="4060e4ba06519fdbdd3a1a64f88f6b35" /><input type="hidden" name="id" value="tutorial:synthesis:initialisation:start" /><input type="hidden" name="bureaucracy[$$id]" value="1" /><fieldset ><legend>Comments or suggestions for improving this tutorial</legend>
<label><span>Name (optional)</span> <input type="text" name="bureaucracy[1]" class="edit" /></label>
<label><span>Email (optional)</span> <input type="text" name="bureaucracy[2]" class="edit" /></label>
<label class=" textareafield">
    <span>Feedback <sup>*</sup></span>
    <textarea name="bureaucracy[3]" id="" rows="10" cols="10" class="edit required&quot; required=&quot;required"></textarea>
</label><button type="submit">Submit</button>
</fieldset>
</div></form>
</div><div class="wrap_hide plugin_wrap"><ul>
<li class="level"><div class="li">
 As discussed in <a href="https://www.dokuwiki.org/plugin:include#controlling_header_size_in_included_pages" class="urlextern" title="https://www.dokuwiki.org/plugin:include#controlling_header_size_in_included_pages" rel="nofollow">https://www.dokuwiki.org/plugin:include#controlling_header_size_in_included_pages</a>, by default, the headers in included pages start one level lower than the last header in the current page. This can be tweaked by adding an empty header above the include:\\<pre class="code">====== ======
{{page&gt;:tutorial:feedback&amp;inline}}</pre>

<p>

</div></li>
<li class="level"><div class="li">
 For offline help generation the content of <code>feedback</code> page should be temporary wrapped in <code>&lt;WRAP hide&gt;</code>. Note that the headers still propagate to the table of contents even if inside the hidden wrap. Therefore the <strong>Feedback</strong> title needs to be converted to something else, e.g. to code by adding two spaces in front.
</p>

</div></li>
</ul>

</div></div>

</div>

                    <!-- wikipage stop -->
                                    </div>
<!--
                                    <div class="docInfo"><bdi>tutorial/synthesis/initialisation/start.txt</bdi> · Last modified: 2018/10/31 14:49 by <bdi>danil</bdi></div>
                -->

                            </div></div><!-- /content -->

            <hr class="a11y" />

            <!-- PAGE ACTIONS -->
<!--
            <div id="dokuwiki__pagetools">
                            <h3 class="a11y">Page Tools</h3>
                <div class="tools">
                    <ul>
                        <li><a href="start.html"  class="action edit" accesskey="e" rel="nofollow" title="Edit this page [E]"><span>Edit this page</span></a></li><li><a href="start.html"  class="action revs" accesskey="o" rel="nofollow" title="Old revisions [O]"><span>Old revisions</span></a></li><li><a href="start.html"  class="action backlink" rel="nofollow" title="Backlinks"><span>Backlinks</span></a></li><li class="plugin_move_page"><a href="start.html"><span>Rename Page</span></a></li><li><a href="#dokuwiki__top"  class="action top" accesskey="t" rel="nofollow" title="Back to top [T]"><span>Back to top</span></a></li><li><a href="start.html"  class="action siteexport_addpage" title="Export Page (Siteexport)"><span>Export Page</span></a></li><li><a href="javascript:void(0);" class="fold_unfold_all" onclick="fold_unfold_all();" rel="nofollow" title="Fold/unfold all"><span>Fold/unfold all</span></a></li><li><a href="start.html"  class="action siteexport_mapid" title="Show Map-ID"" data-mapid="start" onclick="copyMapIDToClipBoard.call(this); return false;"><span>Copy Map-ID: <span class="mapID" data-done="Done.">start</span></span></a></li>                    </ul>
                </div>
                        </div>
-->
        </div><!-- /wrapper -->

        
<!-- ********** FOOTER ********** -->
<div id="dokuwiki__footer"><div class="pad">
<!--
    
    <div class="buttons">
                <a href="http://www.dokuwiki.org/donate" title="Donate" ><img
            src="../../lib/tpl/dokuwiki-light-export/images/button-donate.gif" width="80" height="15" alt="Donate" /></a>
        <a href="http://php.net" title="Powered by PHP" ><img
            src="../../lib/tpl/dokuwiki-light-export/images/button-php.gif" width="80" height="15" alt="Powered by PHP" /></a>
        <a href="http://validator.w3.org/check/referer" title="Valid HTML5" ><img
            src="../../lib/tpl/dokuwiki-light-export/images/button-html5.png" width="80" height="15" alt="Valid HTML5" /></a>
        <a href="http://jigsaw.w3.org/css-validator/check/referer?profile=css3" title="Valid CSS" ><img
            src="../../lib/tpl/dokuwiki-light-export/images/button-css.png" width="80" height="15" alt="Valid CSS" /></a>
        <a href="http://dokuwiki.org/" title="Driven by DokuWiki" ><img
            src="../../lib/tpl/dokuwiki-light-export/images/button-dw.png" width="80" height="15" alt="Driven by DokuWiki" /></a>
    </div>
    <div class="userInfo">
        Logged in as:: danil    </div>
-->
</div></div><!-- /footer -->

    </div></div><!-- /site -->

    <div class="no"><img  width="2" height="1" alt="" /></div>
    <div id="screen__mode" class="no"></div></body>
</html>
