<!DOCTYPE html>
<html lang="en" dir="ltr" class="no-js">
<head>
    <meta charset="utf-8" />
    <title>tutorial:wtg:decoder - Workcraft</title>
    <script>(function(H){H.className=H.className.replace(/\bno-js\b/,'js')})(document.documentElement)</script>
    <meta name="generator" content="DokuWiki"/>
<meta name="robots" content="index,follow"/>
<meta name="keywords" content="tutorial,wtg,decoder"/>
<link rel="search" type="application/opensearchdescription+xml" href="../lib/exe/opensearch.html" title="Workcraft"/>
<link rel="start" href="decoder.html"/>
<link rel="contents" href="decoder.html" title="Sitemap"/>
<link rel="alternate" type="application/rss+xml" title="Changes" />
<link rel="alternate" type="application/rss+xml" title="Current namespace" />
<link rel="edit" title="Edit this page" href="decoder.html"/>
<link rel="alternate" type="text/html" title="Plain HTML" href="../_export/xhtml/tutorial/wtg/decoder.xhtml"/>
<link rel="alternate" type="text/plain" title="Wiki Markup" href="../_export/raw/tutorial/wtg/decoder.raw"/>
<link rel="canonical" href="https://workcraft.org/tutorial/wtg/decoder"/>
<link rel="stylesheet" type="text/css" href="../lib/exe/css.php.t.dokuwiki-light-export.css"/>
<!--[if gte IE 9]><!-->
<script type="text/javascript">/*<![CDATA[*/var NS='tutorial:wtg';var SIG=' --- //[[support@workcraft.org| ]] 2019/07/30 12:26//';var JSINFO = {"id":"tutorial:wtg:decoder","namespace":"tutorial:wtg","fastwiki":{"secedit":1,"preview":1,"fastpages":1,"save":0,"fastshow":0,"fastshow_same_ns":1,"fastshow_include":"","fastshow_exclude":"","preload":false,"preload_head":"====47hsjwycv782nwncv8b920m8bv72jmdm3929bno3b3====","preload_batchsize":false,"preload_per_page":false,"locktime":840,"usedraft":1,"text_btn_show":"Show page","templatename":"dokuwiki-light-export"},"act":"show","ajax":"ajax","move_renameokay":true,"plugin_folded":{"hide":"hide","reveal":"reveal"}};
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="../lib/exe/jquery.php.t.dokuwiki-light-export.js"></script>
<script type="text/javascript" charset="utf-8" src="../lib/exe/js.php.t.dokuwiki-light-export.js"></script>
<!--<![endif]-->
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="shortcut icon" href="../favicon.ico" />
<link rel="apple-touch-icon" href="../apple-touch-icon.png" />
    </head>

<body>
    <div id="dokuwiki__site"><div id="dokuwiki__top" class="site dokuwiki mode_show tpl_dokuwiki-light-export loggedIn    ">

        
<!-- ********** HEADER ********** -->
<div id="dokuwiki__header"><div class="pad group">

        <h1><a href="../start.html"  title="Workcraft start page"><img src="../logo.png" width="327" height="57" alt="" /></a></h1>
    
    <div class="tools group">
        <!-- USER TOOLS -->
<!--
                    <div id="dokuwiki__usertools">
                <h3 class="a11y">User Tools</h3>
                <ul>
                    <li><a href="decoder.html"  class="action admin" rel="nofollow" title="Admin">Admin</a></li><li><a href="decoder.html"  class="action profile" rel="nofollow" title="Profile">Profile</a></li><li><a href="decoder.html"  class="action logout" rel="nofollow" title="Log Out">Log Out</a></li>                </ul>
            </div>
        -->

        <!-- SEARCH TOOLS -->
<!--
        <div id="dokuwiki__searchtools">
            <h3 class="a11y"></h3>
            <form action="../start.html" accept-charset="utf-8" class="search" id="dw__search" method="get" role="search"><div class="no"><input type="hidden" name="do" value="search" /><input type="text" placeholder="Search" id="qsearch__in" accesskey="f" name="id" class="edit" title="[F]" /><button type="submit" title="Search">Search</button><div id="qsearch__out" class="ajax_qsearch JSpopup"></div></div></form>        </div>
-->

        <!-- SITE TOOLS -->
<!--
        <div id="dokuwiki__sitetools">
            <h3 class="a11y">Site Tools</h3>
                            <div class="mobileTools">
                    <form action="..//doku.html.doku.php.html" method="get" accept-charset="utf-8"><div class="no"><input type="hidden" name="id" value="tutorial:wtg:decoder" /><input type="hidden" name="sectok" value="012c6992dd13f7fe10f571bca56fd926" /><select name="do" class="edit quickselect" title="Tools"><option value="">Tools</option><optgroup label="Page Tools"><option value="edit">Edit this page</option><option value="revisions">Old revisions</option><option value="backlink">Backlinks</option></optgroup><optgroup label="Site Tools"><option value="recent">Changes</option><option value="media">Manager</option><option value="index">Sitemap</option></optgroup><optgroup label="User Tools"><option value="logout">Log Out</option><option value="profile">Profile</option><option value="admin">Admin</option></optgroup></select><button type="submit">&gt;</button></div></form>                </div>
                <ul>
                    <li><a href="decoder.html"  class="action recent" accesskey="r" rel="nofollow" title="Changes [R]">Changes</a></li><li><a href="decoder.html"  class="action media" rel="nofollow" title="Manager">Manager</a></li><li><a href="decoder.html"  class="action index" accesskey="x" rel="nofollow" title="Sitemap [X]">Sitemap</a></li>                </ul>
                    </div>
-->
    </div>

    <!-- BREADCRUMBS -->
<!--
    -->



    <hr class="a11y" />
</div></div><!-- /header -->

        <div class="wrapper group">

            
            <!-- ********** CONTENT ********** -->
            <div id="dokuwiki__content"><div class="pad group">
                
                <div class="pageId"><span>tutorial:wtg:decoder</span></div>

                <div class="page group">
                                                            <!-- wikipage start -->
                    <div class="plugin_fastwiki_marker" style="display:none"></div><!-- TOC START -->
<div id="dw__toc">
<h3 class="toggle">Table of Contents</h3>
<div>

<ul class="toc">
<li class="level1"><div class="li"><a href="#exercise_1arithmetic_instructions">Exercise 1: Arithmetic Instructions</a></div></li>
<li class="level1"><div class="li"><a href="#exercise_2branch_instructions">Exercise 2: Branch Instructions</a></div></li>
<li class="level1"><div class="li"><a href="#exercise_3simplify_the_model">Exercise 3: Simplify the model</a></div></li>
<li class="level1"><div class="li"><a href="#exercise_4load_and_store_instructions">Exercise 4: Load and Store Instructions</a></div></li>
<li class="level1"><div class="li"><a href="#solutions">Solutions</a></div></li>
</ul>
</div>
</div>
<!-- TOC END -->

<h1 id="instruction_decoder_and_controller">Instruction decoder and controller</h1>
<div class="level1">

<p>
An Instruction Decoder is a circuit that processors implement in order to interpret instructions coming from memory. In synchronous designs, this circuit feeds the appropriate operands into the datapath of the processor, according to the instruction. Additionally, it must communicate with a Controller, whose role is to direct the flow of the execution at every stage of the pipeline. 
</p>

<p>
In this exercise we are interested in implementing the instruction decoder and controller for a small asynchronous processor. While these are often different circuits, in this case the simplicity of the processor allows us to incorporate all the functionality into a single module. From now on, in this exercise, we will refer to this combined module simply as Decoder.
</p>

<p>
The following figure shows a block diagram of the relevant processor modules. 
</p>

<p>
<img src="instruction_decoder-diagram.svg" width="500" height="653" class="svgscaleinsert mediacenter" alt="tutorial:wtg:instruction_decoder-diagram.svg">
</p>

<p>
The diagram contains 6 blocks. Your task is to implement the block labelled as <em>DEC</em>. All the input and output signals for <em>DEC</em> are colored in red and blue, respectively. Signals in black do not interact with <em>DEC</em> and are shown only to provide context.
</p>

<p>
The different modules operate in the following way:
</p>
<ul>
<li class="level"><div class="li">
 The instruction controller <em>INST</em> loads an instruction from memory and sets it into the instruction bus. When the bus is stabilised, it initiates a decoding request by firing the signal <code><span style='color:red; '>dec</span></code>. After the instruction has been executed, as indicated by the <code><span style='color:blue; '>dec_ack</span></code> signal, this module requests a new address from the <em>IPC</em> module and loads it from memory.
</div></li>
<li class="level"><div class="li">
 The data memory <em>DATA MEM</em> has an address port <code>@</code> obtained directly from the instruction bus. It supports two types of operations, read and write, that are requested with the signals <code><span style='color:blue; '>mr</span></code> and <code><span style='color:blue; '>mw</span></code>, respectively. After a read operation is finished, <em>DATA MEM</em> will set the memory value from the address in <code>@</code> into the read port <code>r</code> and enable <code><span style='color:red; '>mr_ack</span></code>. Write operations are similarly handled with the signals <code><span style='color:blue; '>mw</span></code> and <code><span style='color:red; '>mw_ack</span></code>. In this case, the data to write must be stable before <code><span style='color:blue; '>mw</span></code> is enabled.
</div></li>
<li class="level"><div class="li">
 The register block <em>REG</em> contains a small number of registers that can store values to perform arithmetic operations. It contains two read ports, <code>a</code> and <code>b</code>, and one write port <code>d</code>. Like in the case of <em>DATA MEM</em>, the port addresses are obtained directly from the instruction bus. The signals <code><span style='color:blue; '>rgr</span></code> and <code><span style='color:blue; '>rgw</span></code> are used to request read and write operations, respectively. The signals <code><span style='color:red; '>rgr_ack</span></code> and <code><span style='color:red; '>rgw_ack</span></code> acknowledge these operations in the same way as in the <em>DATA MEM</em> module.
</div></li>
<li class="level"><div class="li">
 The <em>ALU</em> module performs arithmetic operations. It decides what operation to execute according to the <code>op</code> port that comes from the instruction bus. It has three ports for its operands: <code>imm</code>, <code>a</code> and <code>b</code>. The first port allows the <em>ALU</em> to obtain values directly from the instruction bus, while <code>a</code> and <code>b</code> must be read from the register. The signal <code><span style='color:blue; '>alu</span></code> informs the <em>ALU</em> that the operands are set and an operation can take place. The result of this operation is placed in the output port <code>d</code>. After an operation is complete, the signal <code><span style='color:red; '>alu_ack</span></code> is enabled. Furthermore, a signal <code><span style='color:red; '>z</span></code> is enabled if the result of the operation was <em>zero</em>. This value is guaranteed to remain stable until after the following operation is requested.
</div></li>
<li class="level"><div class="li">
 The <em>IPC</em> module stands for Instruction Process Counter, and its role is to keep track of the address for the instruction memory. In general, it keeps a copy of the last address loaded and increases it by one when the instruction controller requests a new address. It is also possible to request the module to add an <em>offset</em> different than one to the next address by enabling the signal <code><span style='color:blue; '>jmp</span></code>. The offset is obtained from the port <code>imp_ofs</code> directly from the instruction bus.
</div></li>
</ul>


<p>
The processor implements four instructions that must be decoded and controlled by <em>DEC</em>:
</p>
<ul>
<li class="level"><div class="li">
 <strong>Arithmetic operation</strong>. Performs an arithmetic operation and stores the result in the register. Corresponds to the code <code><span style='color:red; '>op0</span> = 0</code>, <code><span style='color:red; '>op1</span> = 0</code>.
</div></li>
<li class="level"><div class="li">
 <strong>Branch operation</strong>. If the result of the last arithmetic operation is a <code>0</code>, adds an offset into the next instruction address. Corresponds to the code <code><span style='color:red; '>op0</span> = 0</code>, <code><span style='color:red; '>op1</span> = 1</code>.
</div></li>
<li class="level"><div class="li">
 <strong>Load from memory</strong>. Reads from memory and stores the value into the register. Corresponds to the code <code><span style='color:red; '>op0</span> = 1</code>, <code><span style='color:red; '>op1</span> = 0</code>.
</div></li>
<li class="level"><div class="li">
 <strong>Store in memory</strong>. Stores a value from the register into memory. Corresponds to the code <code><span style='color:red; '>op0</span> = 1</code>, <code><span style='color:red; '>op1</span> = 1</code>.
</div></li>
</ul>


</div>

<h2 id="exercise_1arithmetic_instructions">Exercise 1: Arithmetic Instructions</h2>
<div class="level2">

<p>
The first instruction you have to implement is the arithmetic instruction. But before that, it is always a good idea with <abbr title="Waveform Transition Graph">WTG</abbr> to first set the basic structure of the controller. This not only makes it easier to approach the problem, but also allows Workcraft to infer signal values when possible. 
</p>

<p>
Let us first define the initialization and leave a waveform for every instruction. Remember to rename every waveform with the instruction it intends to solve.
</p>
<p><a class="folder" href="#folded_tutorial:wtg:decoder_1">Detailed instructions </a></p><div class="folded hidden" id="folded_tutorial:wtg:decoder_1"><ul>
<li class="level"><div class="li">
 Place a state and double click on it to set it as initial.
</div></li>
<li class="level"><div class="li">
 Add a new waveform, rename it <em>initialisation</em> and add a connection from the initial state. A signal cannot be <code>unstable</code> in the first initial state. We will assume that, in the initialization of this circuit, the signals <code><span style='color:red; '>op0</span></code> and <code><span style='color:red; '>op1</span></code> are <code>low</code> before becoming <code>unstable</code>.
</div><ul>
<li class="level"><div class="li">
 Click on the signal tool and hold <kbd class="__keyboard">Shift</kbd> while clicking twice to add two input signals.
</div></li>
<li class="level"><div class="li">
 Rename them <code><span style='color:red; '>op0</span></code> and <code><span style='color:red; '>op1</span></code>.
</div></li>
<li class="level"><div class="li">
 Double click on them while holding <kbd class="__keyboard">Shift</kbd> and <kbd class="__keyboard">Ctrl</kbd> to add a <code>destabilise</code> transition.
</div></li>
<li class="level"><div class="li">
 Double click on them again to add <code>stabilise</code> transitions.
</div></li>
</ul>
</li>
<li class="level"><div class="li">
 Add a new state and four waveforms. Add a connection between <em>initialisation</em> and the state, and from the state to the new waveforms. 
</div></li>
<li class="level"><div class="li">
 Rename each waveform with one of the instructions: <em>arithmetic</em>, <em>branch</em>, <em>load</em> and <em>store</em>.
</div></li>
<li class="level"><div class="li">
 Set a guard for each waveform depending on the operation it implements:
</div><ul>
<li class="level"><div class="li">
 Click on the <em>arithmetic</em> waveform and set, in the <em>guard</em> field on the property editor, the guard <code>!op0, !op1</code>.
</div></li>
<li class="level"><div class="li">
 Click on the <em>branch</em> waveform and set, in the <em>guard</em> field on the property editor, the guard <code>!op0, op1</code>.
</div></li>
<li class="level"><div class="li">
 Click on the <em>load</em> waveform and set, in the <em>guard</em> field on the property editor, the guard <code>op0, !op1</code>.
</div></li>
<li class="level"><div class="li">
 Click on the <em>store</em> waveform and set, in the <em>guard</em> field on the property editor the guard,  <code>op0, op1</code>.
</div></li>
</ul>
</li>
</ul>

</div>
<p>
The <abbr title="Waveform Transition Graph">WTG</abbr> should look similar to the following figure.
</p>

<p>
<img src="instruction_decoder-wtg_structure.svg" width="305" height="322" class="svgscaleinsert mediacenter" alt="tutorial:wtg:instruction_decoder-wtg_structure.svg">
</p>

<p>
You can now implement the arithmetic instruction controller.
</p>
<p><a class="folder" href="#folded_tutorial:wtg:decoder_2">Detailed instructions </a></p><div class="folded hidden" id="folded_tutorial:wtg:decoder_2"><ul>
<li class="level"><div class="li">
 Double click on the <em>arithmetic</em> waveform to move to the waveform level. 
</div></li>
<li class="level"><div class="li">
 Use the property editor to declare the signals <code><span style='color:red; '>op0</span></code> and <code><span style='color:red; '>op1</span></code> by clicking on their checkbox.
</div></li>
<li class="level"><div class="li">
 This instruction requires interactions with the modules <em>INST</em>, <em>REG</em> and <em>ALU</em>. Add all the signals used to interact with them:
</div><ul>
<li class="level"><div class="li">
 Add the input signals <code><span style='color:red; '>dec</span></code>, <code><span style='color:red; '>rgr_ack</span></code>, <code><span style='color:red; '>rgw_ack</span></code> and <code><span style='color:red; '>alu_ack</span></code>. The signal <code><span style='color:red; '>z</span></code> is not needed for this instruction and so it can be ignored.
</div></li>
<li class="level"><div class="li">
 Add the output signals <code><span style='color:blue; '>dec_ack</span></code>, <code><span style='color:blue; '>rgr</span></code>, <code><span style='color:blue; '>rgw</span></code>, <code><span style='color:blue; '>alu</span></code>.
</div></li>
<li class="level"><div class="li">
 Remember that signals can be reorganized by holding <kbd class="__keyboard">Shift</kbd> while dragging them vertically.
</div></li>
</ul>
</li>
<li class="level"><div class="li">
 The signal <code><span style='color:red; '>dec</span></code> indicates the start of this scenario. First, the operands must be loaded from the register into the <em>ALU</em>:
</div><ul>
<li class="level"><div class="li">
 Add a <code>rise</code> transition for signals <code><span style='color:red; '>dec</span></code> and <code><span style='color:blue; '>rgr</span></code> by double clicking on them.
</div></li>
<li class="level"><div class="li">
 Add a connection from the transition of <code><span style='color:red; '>dec</span></code> to the transition of <code><span style='color:blue; '>rgr</span></code>
</div></li>
</ul>
</li>
<li class="level"><div class="li">
 When the register is done loading the values in its output ports, it will <code>rise</code> the <code><span style='color:red; '>rgr_ack</span></code> signal. We can then request <em>ALU</em> to perform the operation.
</div><ul>
<li class="level"><div class="li">
 Add <code>rise</code> transitions to the signals <code><span style='color:red; '>rgr_ack</span></code> and <code><span style='color:blue; '>alu</span></code>.
</div></li>
<li class="level"><div class="li">
 Connect the transition of <code><span style='color:blue; '>rgr</span></code> to the transition of <code><span style='color:red; '>rgr_ack</span></code>, and the transition from <code><span style='color:red; '>rgr_ack</span></code> to the transition of <code><span style='color:blue; '>alu</span></code>.
</div></li>
</ul>
</li>
<li class="level"><div class="li">
 The <em>ALU</em> will <code>rise</code> the signal <code><span style='color:red; '>alu_ack</span></code> after the operation is performed. The register can then be requested to write the result. 
</div><ul>
<li class="level"><div class="li">
 Add new <code>rise</code> transitions for signals <code><span style='color:red; '>alu_ack</span></code> and <code><span style='color:blue; '>rgw</span></code>. 
</div></li>
<li class="level"><div class="li">
 Connect the transition of <code><span style='color:blue; '>alu</span></code> to the transition of <code><span style='color:red; '>alu_ack</span></code>.
</div></li>
<li class="level"><div class="li">
 Connect the transition of <code><span style='color:red; '>alu_ack</span></code> to the transition of <code><span style='color:blue; '>rgw</span></code>.
</div></li>
</ul>
</li>
<li class="level"><div class="li">
 After the register has finished storing the result of the operation, the <em>ALU</em> can stop holding the value and drop the request to write in the register. This can be done in parallel.
</div><ul>
<li class="level"><div class="li">
 Connect the transition from <code><span style='color:blue; '>rgw</span></code> to a new transition for signal <code><span style='color:red; '>rgw_ack</span></code>.
</div></li>
<li class="level"><div class="li">
 Add <code>fall</code> transitions for signals <code><span style='color:blue; '>rgw</span></code> and <code><span style='color:blue; '>alu</span></code>.
</div></li>
<li class="level"><div class="li">
 Connect the transition for signal <code><span style='color:red; '>rgw_ack</span></code> to the <code>fall</code> transitions of <code><span style='color:blue; '>rgw</span></code> and <code><span style='color:blue; '>alu</span></code>.
</div></li>
</ul>
</li>
<li class="level"><div class="li">
 When the <em>ALU</em> acknowledges the end of the operation, we can drop the request to read from the register.
</div><ul>
<li class="level"><div class="li">
 Add a <code>fall</code> transition for signals <code><span style='color:red; '>alu_ack</span></code> and <code><span style='color:blue; '>rgr</span></code>.
</div></li>
<li class="level"><div class="li">
 Connect the <code>fall</code> transition of signal <code><span style='color:blue; '>alu</span></code> to the <code>fall</code> transition of <code><span style='color:red; '>alu_ack</span></code>, and the <code>fall</code> transition of <code><span style='color:red; '>alu_ack</span></code> to the <code>fall</code> transition of <code><span style='color:blue; '>rgr</span></code>.
</div></li>
</ul>
</li>
<li class="level"><div class="li">
 After the register acknowledges the end of the read and write operations, the decoder informs that the operation has been finished.
</div><ul>
<li class="level"><div class="li">
 Add a <code>fall</code> transition for signals <code><span style='color:red; '>rgr_ack</span></code> and <code><span style='color:red; '>rgw_ack</span></code> and a <code>rise</code> transition for signal <code><span style='color:blue; '>dec_ack</span></code>.
</div></li>
<li class="level"><div class="li">
 Connect the <code>fall</code> transition of <code><span style='color:blue; '>rgr</span></code> to the <code>fall</code> transition of <code><span style='color:red; '>rgr_ack</span></code>.
</div></li>
<li class="level"><div class="li">
 Connect the <code>fall</code> transition of <code><span style='color:blue; '>rgw</span></code> to the <code>fall</code> transition of <code><span style='color:red; '>rgw_ack</span></code>.
</div></li>
<li class="level"><div class="li">
 Connect the <code>fall</code> transition of <code><span style='color:red; '>rgr_ack</span></code> and <code><span style='color:red; '>rgw_ack</span></code> to the <code>rise</code> transition of <code><span style='color:blue; '>dec_ack</span></code>.
</div></li>
</ul>
</li>
<li class="level"><div class="li">
 Since the operation is finished, the signals <code><span style='color:red; '>op0</span></code> and <code><span style='color:red; '>op1</span></code> might change value and so they should be considered <code>unstable</code>. In parallel, <code><span style='color:red; '>dec</span></code> acknowledges the finalization of the operation.
</div><ul>
<li class="level"><div class="li">
 Add <code>destabilise</code> transitions to signals <code><span style='color:red; '>op0</span></code> and <code><span style='color:red; '>op1</span></code>.
</div></li>
<li class="level"><div class="li">
 Add a <code>fall</code> transition to signal <code><span style='color:red; '>dec</span></code>.
</div></li>
<li class="level"><div class="li">
 Connect the <code>rise</code> transition from signal <code><span style='color:blue; '>dec_ack</span></code> to the transitions you just added.
</div></li>
<li class="level"><div class="li">
 Add a <code>fall</code> transition for signal <code><span style='color:blue; '>dec_ack</span></code>.
</div></li>
<li class="level"><div class="li">
 Connect the <code>fall</code> transition of signal <code><span style='color:red; '>dec</span></code> to the <code>fall</code> transition of <code><span style='color:blue; '>dec_ack</span></code>.
</div></li>
</ul>
</li>
<li class="level"><div class="li">
 At some point before the end of the waveform, the signals op0 and op1 must become <code>stable</code>.
</div><ul>
<li class="level"><div class="li">
 Double click the signals <code><span style='color:red; '>op0</span></code> and <code><span style='color:red; '>op1</span></code> to add a <code>stabilise</code> transition.
</div></li>
</ul>
</li>
<li class="level"><div class="li">
 The instruction is now complete and the decoder waits for the next instruction.
</div><ul>
<li class="level"><div class="li">
 At the waveform level, add a connection from <em>arithmetic</em> to the previous nodal state.
</div></li>
</ul>
</li>
</ul>

</div>
<p>
The implementation for the first signal can be seen in the next figure.
</p>

<p>
<img src="instruction_decoder-arithmetic.svg" width="637" height="509" class="svgscaleinsert mediacenter" alt="tutorial:wtg:instruction_decoder-arithmetic.svg">
</p>

</div>

<h2 id="exercise_2branch_instructions">Exercise 2: Branch Instructions</h2>
<div class="level2">

<p>
The next instruction we will implement is the branching instruction. This instruction allows the processor to alter the execution flow depending on logic conditions. Any operation performed in the <em>ALU</em> will set the signal <code><span style='color:red; '>z</span></code> to <code>high</code> if the result was <code>zero</code>. It will set <code>low</code> otherwise. By using this signal we can determine whether to branch or not.
</p>

<p>
This instruction will need to use <em>guards</em>. Implement structure of the <abbr title="Waveform Transition Graph">WTG</abbr> for the branch instruction and the common waveform before the <em>guard</em>. Keep in mind that <code><span style='color:red; '>z</span></code> has to be initialized in a similar way to <code><span style='color:red; '>op0</span></code> and <code><span style='color:red; '>op1</span></code>. The value of this signal is only relevant to the branch operation, so it should remain <code>unstable</code> in every waveform and become <code>stable</code> when we need it.
</p>
<p><a class="folder" href="#folded_tutorial:wtg:decoder_3">Detailed instructions </a></p><div class="folded hidden" id="folded_tutorial:wtg:decoder_3"><ul>
<li class="level"><div class="li">
 The signal <code><span style='color:red; '>z</span></code> is <code>unstable</code> in most waveforms, but it first needs to be initialised with a known value.
</div><ul>
<li class="level"><div class="li">
 Double click the <em>initialisation</em> waveform and add a new input signal <code><span style='color:red; '>z</span></code>.
</div></li>
<li class="level"><div class="li">
 Add a <code>destabilise</code> transition by double clicking <code><span style='color:red; '>z</span></code> while holding <kbd class="__keyboard">Shift</kbd> and <kbd class="__keyboard">Ctrl</kbd>.
</div></li>
</ul>
</li>
<li class="level"><div class="li">
 A waveform with a guard must always declare the signals that are guarded.
</div><ul>
<li class="level"><div class="li">
 Double click the <em>branch</em> waveform and declare the signals <code><span style='color:red; '>op0</span></code> and <code><span style='color:red; '>op1</span></code> in the property editor.
</div></li>
</ul>
</li>
<li class="level"><div class="li">
 The signal <code><span style='color:red; '>z</span></code> is necessary to determine whether branching occurs. This signal must become <code>stable</code> before taking a decision.
</div><ul>
<li class="level"><div class="li">
 Use the property editor to declare <code><span style='color:red; '>z</span></code>.
</div></li>
<li class="level"><div class="li">
 Double click on <code><span style='color:red; '>z</span></code> to add a <code>stabilise</code> transition.
</div></li>
</ul>
</li>
<li class="level"><div class="li">
 The model must now decide what to do depending on the value of <code><span style='color:red; '>z</span></code>.
</div><ul>
<li class="level"><div class="li">
 Go to the state level by double clicking outside of the waveform.
</div></li>
<li class="level"><div class="li">
 Place a new state and a connection between <em>branch</em> and the state.
</div></li>
<li class="level"><div class="li">
 Place two new waveforms and rename them <em>no_jmp</em> and <em>jmp</em>.
</div></li>
<li class="level"><div class="li">
 Add a connection from the new state to the new waveforms.
</div></li>
<li class="level"><div class="li">
 Click on <em>no_jmp</em> and, in the property editor, set the <em>Guard</em> field to <code>!z</code>.
</div></li>
<li class="level"><div class="li">
 Click on <em>jmp</em> and, in the property editor, set the <em>Guard</em> field to <code>z</code>.
</div></li>
</ul>
</li>
</ul>

</div>
<p>
The resulting <abbr title="Waveform Transition Graph">WTG</abbr> can be seen in the following figure.
</p>

<p>
<img src="instruction_decoder-branch_structure.svg" width="656" height="572" class="svgscaleinsert mediacenter" alt="tutorial:wtg:instruction_decoder-branch_structure.svg">
</p>

<p>
The simplest scenario occurs when <code><span style='color:red; '>z</span></code> is <code>low</code>. In this case, there is nothing to do and <em>DEC</em> immediately acknowledges the instruction after the decoding request. Implement the waveform for this scenario.
</p>
<p><a class="folder" href="#folded_tutorial:wtg:decoder_4">Detailed instructions </a></p><div class="folded hidden" id="folded_tutorial:wtg:decoder_4"><ul>
<li class="level"><div class="li">
 Declare the signals that are needed to process this scenario.
</div><ul>
<li class="level"><div class="li">
 In the property editor, use the <em>declare</em> button for the signals <code><span style='color:red; '>z</span></code>, <code><span style='color:red; '>dec</span></code>, <code><span style='color:red; '>op0</span></code>, <code><span style='color:red; '>op1</span></code> and <code><span style='color:blue; '>dec_ack</span></code>.
</div></li>
</ul>
</li>
<li class="level"><div class="li">
 The first transition must be the request for the operation. This is immediately acknowledged in this scenario, since there is nothing to be done.
</div><ul>
<li class="level"><div class="li">
 Add a <code>rise</code> transition for signals <code><span style='color:red; '>dec</span></code> and <code><span style='color:blue; '>dec_ack</span></code>.
</div></li>
<li class="level"><div class="li">
 Add a connection from the transition of <code><span style='color:red; '>dec</span></code> to the transition of <code><span style='color:blue; '>dec_ack</span></code>.
</div></li>
</ul>
</li>
<li class="level"><div class="li">
 Signals <code><span style='color:red; '>z</span></code>, <code><span style='color:red; '>op0</span></code> and <code><span style='color:red; '>op1</span></code> are no longer needed and can become <code>unstable</code>. 
</div><ul>
<li class="level"><div class="li">
 Add an <code>unstable</code> transition to signals <code><span style='color:red; '>z</span></code>, <code><span style='color:red; '>op0</span></code> and <code><span style='color:red; '>op1</span></code>.
</div></li>
<li class="level"><div class="li">
 Connect the transition from <code><span style='color:blue; '>dec_ack</span></code> to the transitions of <code><span style='color:red; '>z</span></code>, <code><span style='color:red; '>op0</span></code> and <code><span style='color:red; '>op1</span></code>.
</div></li>
<li class="level"><div class="li">
 Add a <code>stabilise</code> transition to signals <code><span style='color:red; '>op0</span></code> and <code><span style='color:red; '>op1</span></code>.
</div></li>
</ul>
</li>
<li class="level"><div class="li">
 Finally, the request for decoding and the acknowledge can be set to <code>low</code>.
</div><ul>
<li class="level"><div class="li">
 Add a <code>fall</code> transition for signal <code><span style='color:red; '>dec</span></code>.
</div></li>
<li class="level"><div class="li">
 Connect the <code>rise</code> transition of <code><span style='color:blue; '>dec_ack</span></code> to the <code>fall</code> transition of <code><span style='color:red; '>dec</span></code>.
</div></li>
<li class="level"><div class="li">
 Add a <code>fall</code> transition for signal <code><span style='color:blue; '>dec_ack</span></code>.
</div></li>
<li class="level"><div class="li">
 Connect the <code>fall</code> transition of signal <code><span style='color:red; '>dec</span></code> to the <code>fall</code> transition of signal <code><span style='color:blue; '>dec_ack</span></code>.
</div></li>
</ul>
</li>
<li class="level"><div class="li">
 The model returns to its waiting state until a new request arrives.
</div><ul>
<li class="level"><div class="li">
 At the state level, add a connection between <em>no_jmp</em> and the state before the guards.
</div></li>
</ul>
</li>
</ul>

</div>
<p>
You can see the implementation of <em>no_jmp</em> in the following figure.
</p>

<p>
<img src="instruction_decoder-branch_no_jmp.svg" width="656" height="662" class="svgscaleinsert mediacenter" alt="tutorial:wtg:instruction_decoder-branch_no_jmp.svg">
</p>

<p>
Finally, implement the last waveform for the branch instruction.
</p>
<p><a class="folder" href="#folded_tutorial:wtg:decoder_5">Detailed instructions </a></p><div class="folded hidden" id="folded_tutorial:wtg:decoder_5"><ul>
<li class="level"><div class="li">
 Declare the signals that are needed to process this scenario.
</div><ul>
<li class="level"><div class="li">
 In the property editor, use the <em>declare</em> button for the signals <code><span style='color:red; '>z</span></code>, <code><span style='color:red; '>dec</span></code>, <code><span style='color:red; '>op0</span></code>, <code><span style='color:red; '>op1</span></code> and <code><span style='color:blue; '>dec_ack</span></code>.
</div></li>
<li class="level"><div class="li">
 Use the signal tool to declare <code><span style='color:blue; '>jmp</span></code> and <code><span style='color:red; '>ipc_ack</span></code>.
</div></li>
</ul>
</li>
<li class="level"><div class="li">
 The first transition must be the request for the operation. This follows with a request to the <em>IPC</em> to branch the address.
</div><ul>
<li class="level"><div class="li">
 Add a <code>rise</code> transition for signals <code><span style='color:red; '>dec</span></code> and <code><span style='color:blue; '>jmp</span></code>.
</div></li>
<li class="level"><div class="li">
 Add a connection from the transition of <code><span style='color:red; '>dec</span></code> to the transition of <code><span style='color:blue; '>jmp</span></code>.
</div></li>
</ul>
</li>
<li class="level"><div class="li">
 When the transaction with <em>IPC</em> is over, <em>DEC</em> signals the end of the instruction.
</div><ul>
<li class="level"><div class="li">
 Add a <code>rise</code> transition to signal <code><span style='color:red; '>ipc_ack</span></code>.
</div></li>
<li class="level"><div class="li">
 Connect the transition of <code><span style='color:blue; '>jmp</span></code> to the transition of <code><span style='color:red; '>ipc_ack</span></code>.
</div></li>
<li class="level"><div class="li">
 Add <code>fall</code> transitions to signals <code><span style='color:blue; '>jmp</span></code> and <code><span style='color:red; '>ipc_ack</span></code>.
</div></li>
<li class="level"><div class="li">
 Connect the <code>rise</code> transition of <code><span style='color:red; '>ipc_ack</span></code> to the <code>fall</code> transition of <code><span style='color:blue; '>jmp</span></code> and the <code>fall</code> transition of <code><span style='color:blue; '>jmp</span></code> to the <code>fall</code> transition of <code><span style='color:red; '>ipc_ack</span></code>.
</div></li>
<li class="level"><div class="li">
 Add a <code>rise</code> transition to signal <code><span style='color:blue; '>dec_ack</span></code>.
</div></li>
<li class="level"><div class="li">
 Connect the <code>fall</code> transition of <code><span style='color:red; '>ipc_ack</span></code> to the <code>rise</code> transition of <code><span style='color:blue; '>dec_ack</span></code>.
</div></li>
</ul>
</li>
<li class="level"><div class="li">
 Proceed like in the <em>no_jmp</em> waveform to finish this waveform.
</div><ul>
<li class="level"><div class="li">
 Add an <code>unstable</code> transition to signals <code><span style='color:red; '>z</span></code>, <code><span style='color:red; '>op0</span></code> and <code><span style='color:red; '>op1</span></code>.
</div></li>
<li class="level"><div class="li">
 Add a <code>stabilise</code> transition to signals <code><span style='color:red; '>op0</span></code> and <code><span style='color:red; '>op1</span></code>.
</div></li>
<li class="level"><div class="li">
 Add a <code>fall</code> transition for signal <code><span style='color:red; '>dec</span></code>.
</div></li>
<li class="level"><div class="li">
 Connect the transition from <code><span style='color:blue; '>dec_ack</span></code> to the transitions of <code><span style='color:red; '>z</span></code>, <code><span style='color:red; '>op0</span></code>, <code><span style='color:red; '>op1</span></code> and <code><span style='color:red; '>dec</span></code>.
</div></li>
<li class="level"><div class="li">
 Add a <code>fall</code> transition for signal <code><span style='color:blue; '>dec_ack</span></code>.
</div></li>
<li class="level"><div class="li">
 Connect the <code>fall</code> transition of signal <code><span style='color:red; '>dec</span></code> to the <code>fall</code> transition of signal <code><span style='color:blue; '>dec_ack</span></code>.
</div></li>
</ul>
</li>
<li class="level"><div class="li">
 The model returns to its waiting state until a new request arrives.
</div><ul>
<li class="level"><div class="li">
 At the state level, add a connection between <em>jmp</em> and the state before the guard
</div></li>
</ul>
</li>
</ul>

</div>
<p>
The next figure shows a complete implementation of the branch instruction.
</p>

<p>
<img src="instruction_decoder-branch.svg" width="700" height="772" class="svgscaleinsert mediacenter" alt="tutorial:wtg:instruction_decoder-branch.svg">
</p>

</div>

<h2 id="exercise_3simplify_the_model">Exercise 3: Simplify the model</h2>
<div class="level2">

<p>
By looking at our current design, you can observe that the instructions always finish in the same way. This is due to the protocol between <em>DEC</em> and <em>INST</em>. In this exercise, your task is to identify the common parts and create a new waveform called <em>instruction_finished</em> that produces the necessary transitions between completing an instruction and waiting for the next.
</p>
<p><a class="folder" href="#folded_tutorial:wtg:decoder_6">Detailed instructions </a></p><div class="folded hidden" id="folded_tutorial:wtg:decoder_6"><ul>
<li class="level"><div class="li">
 Modify the structure to accommodate for a waveform after the instructions.
</div><ul>
<li class="level"><div class="li">
 Remove the connections that go from the instruction waveforms to the nodal state.
</div></li>
<li class="level"><div class="li">
 Add a new nodal state and connect the waveforms <em>arithmetic</em>, <em>no_jmp</em> and <em>jmp</em> to it.
</div></li>
<li class="level"><div class="li">
 Add a new waveform and a connection from the previous nodal state to this new waveform. Rename the waveform <em>instruction_finished</em>.
</div></li>
<li class="level"><div class="li">
 Add a connection from <em>instruction_finished</em> to the nodal state preceding the instruction waveforms.
</div></li>
</ul>
</li>
<li class="level"><div class="li">
 Remove the common transitions from the instruction waveforms.
</div><ul>
<li class="level"><div class="li">
 Double click on the waveform <em>arithmetic</em>:
</div><ul>
<li class="level"><div class="li">
 Click on the <code>fall</code> transition for signal <code><span style='color:red; '>dec</span></code>.
</div></li>
<li class="level"><div class="li">
 In the property editor, change the <em>Direction</em> to <code>raise</code>. This will remove the transition and the connections to and from it.
</div></li>
<li class="level"><div class="li">
 Follow the same procedure to remove the <code>fall</code> transition for <code><span style='color:blue; '>dec_ack</span></code> and the <code>stabilise</code> transitions for <code><span style='color:red; '>op0</span></code> and <code><span style='color:red; '>op1</span></code>.
</div></li>
</ul>
</li>
<li class="level"><div class="li">
 Repeat the same procedure for the waveforms <em>no_jmp</em> and <em>jmp</em>.
</div></li>
</ul>
</li>
<li class="level"><div class="li">
 Add the removed transitions to the <em>instruction_finished</em> waveform.
</div><ul>
<li class="level"><div class="li">
 Double click on the <em>instruction_finished</em> waveform.
</div></li>
<li class="level"><div class="li">
 Declare the signals <code><span style='color:red; '>op0</span></code>, <code><span style='color:red; '>op1</span></code>, <code><span style='color:red; '>dec</span></code> and <code><span style='color:blue; '>dec_ack</span></code> by using the <em>declare</em> option in the property panel.
</div></li>
<li class="level"><div class="li">
 Add a <code>fall</code> transition to <code><span style='color:red; '>dec</span></code> and <code><span style='color:blue; '>dec_ack</span></code>.
</div></li>
<li class="level"><div class="li">
 Connect the transition of <code><span style='color:red; '>dec</span></code> to the transition of <code><span style='color:blue; '>dec_ack</span></code>.
</div></li>
<li class="level"><div class="li">
 Add <code>stabilise</code> transitions to <code><span style='color:red; '>op0</span></code> and <code><span style='color:red; '>op1</span></code>.
</div></li>
</ul>
</li>
</ul>

</div>
<p>
The simplified <abbr title="Waveform Transition Graph">WTG</abbr> can be seen in the next figure.
</p>

<p>
<img src="instruction_decoder-simplified.svg" width="854" height="732" class="svgscaleinsert mediacenter" alt="tutorial:wtg:instruction_decoder-simplified.svg">
</p>

</div>

<h2 id="exercise_4load_and_store_instructions">Exercise 4: Load and Store Instructions</h2>
<div class="level2">

<p>
The remaining instructions have to access the <em>DATA MEM</em> module for read and write operations. This module uses a similar handshake protocol to the <em>REG</em> module. Complete the <em>DEC</em> module by adding the Load and Store operations to the <abbr title="Waveform Transition Graph">WTG</abbr>.
</p>

<p>
This exercise intentionally lacks detailed instructions to encourage working on it independnetly. You can compare your solution to the complete <abbr title="Waveform Transition Graph">WTG</abbr> of the decoder: <span class="wrap_download "><a href="instruction_decoder.wtg.work" class="media mediafile mf_work" title="tutorial:wtg:instruction_decoder.wtg.work (21 KB)">instruction_decoder.wtg.work</a> (21 KiB)</span>
</p>

</div>

<h2 id="solutions">Solutions</h2>
<div class="level2">

<p>
Download all the Workcraft models discussed in this tutorial here:
</p>

<p>
<span class="wrap_download "><a href="instruction_decoder.zip" class="media mediafile mf_zip" title="tutorial:wtg:instruction_decoder.zip (148.8 KB)">All instruction decoder WTGs</a> (149 KiB)</span>
</p>

</div>

                    <!-- wikipage stop -->
                                    </div>
<!--
                                    <div class="docInfo"><bdi>tutorial/wtg/decoder.txt</bdi> · Last modified: 2018/11/11 14:50 by <bdi>danil</bdi></div>
                -->

                            </div></div><!-- /content -->

            <hr class="a11y" />

            <!-- PAGE ACTIONS -->
<!--
            <div id="dokuwiki__pagetools">
                            <h3 class="a11y">Page Tools</h3>
                <div class="tools">
                    <ul>
                        <li><a href="decoder.html"  class="action edit" accesskey="e" rel="nofollow" title="Edit this page [E]"><span>Edit this page</span></a></li><li><a href="decoder.html"  class="action revs" accesskey="o" rel="nofollow" title="Old revisions [O]"><span>Old revisions</span></a></li><li><a href="decoder.html"  class="action backlink" rel="nofollow" title="Backlinks"><span>Backlinks</span></a></li><li><a href="decoder.html"  class="action export_pdf" rel="nofollow" title="Export to PDF"><span>Export to PDF</span></a></li><li class="plugin_move_page"><a href="decoder.html"><span>Rename Page</span></a></li><li><a href="#dokuwiki__top"  class="action top" accesskey="t" rel="nofollow" title="Back to top [T]"><span>Back to top</span></a></li><li><a href="decoder.html"  class="action siteexport_addpage" title="Export Page (Siteexport)"><span>Export Page</span></a></li><li><a href="javascript:void(0);" class="fold_unfold_all" onclick="fold_unfold_all();" rel="nofollow" title="Fold/unfold all"><span>Fold/unfold all</span></a></li><li><a href="decoder.html"  class="action siteexport_mapid" title="Show Map-ID"" data-mapid="decoder" onclick="copyMapIDToClipBoard.call(this); return false;"><span>Copy Map-ID: <span class="mapID" data-done="Done.">decoder</span></span></a></li>                    </ul>
                </div>
                        </div>
-->
        </div><!-- /wrapper -->

        
<!-- ********** FOOTER ********** -->
<div id="dokuwiki__footer"><div class="pad">
<!--
    
    <div class="buttons">
                <a href="http://www.dokuwiki.org/donate" title="Donate" ><img
            src="../lib/tpl/dokuwiki-light-export/images/button-donate.gif" width="80" height="15" alt="Donate" /></a>
        <a href="http://php.net" title="Powered by PHP" ><img
            src="../lib/tpl/dokuwiki-light-export/images/button-php.gif" width="80" height="15" alt="Powered by PHP" /></a>
        <a href="http://validator.w3.org/check/referer" title="Valid HTML5" ><img
            src="../lib/tpl/dokuwiki-light-export/images/button-html5.png" width="80" height="15" alt="Valid HTML5" /></a>
        <a href="http://jigsaw.w3.org/css-validator/check/referer?profile=css3" title="Valid CSS" ><img
            src="../lib/tpl/dokuwiki-light-export/images/button-css.png" width="80" height="15" alt="Valid CSS" /></a>
        <a href="http://dokuwiki.org/" title="Driven by DokuWiki" ><img
            src="../lib/tpl/dokuwiki-light-export/images/button-dw.png" width="80" height="15" alt="Driven by DokuWiki" /></a>
    </div>
    <div class="userInfo">
        Logged in as:: workcraft    </div>
-->
</div></div><!-- /footer -->

    </div></div><!-- /site -->

    <div class="no"><img  width="2" height="1" alt="" /></div>
    <div id="screen__mode" class="no"></div></body>
</html>
